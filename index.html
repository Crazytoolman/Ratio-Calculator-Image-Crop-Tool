<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="专业的比例计算器和图像裁切工具，支持常用照片比例、屏幕比例等，自定义比例计算更方便，在线裁切图片">
    <title>比例计算器与图像裁切拼接工具 - 智能尺寸计算与图片裁切拼接</title>
    <!-- SVG Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg viewBox='0 0 48 48' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='icon-grad-2' x1='48' y1='0' x2='0' y2='48' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0%25' stop-color='%23FF2D55' /%3E%3Cstop offset='100%25' stop-color='%23FF9500' /%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M12 38V12C12 9.79086 13.7909 8 16 8H40' stroke='url(%23icon-grad-2)' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M36 10V36C36 38.2091 34.2091 40 32 40H8' stroke='url(%23icon-grad-2)' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M12 14V6' stroke='url(%23icon-grad-2)' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M42 8H34' stroke='url(%23icon-grad-2)' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M6 40H14' stroke='url(%23icon-grad-2)' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M36 34V42' stroke='url(%23icon-grad-2)' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* 浅色主题 - Apple风格 */
            --bg-gradient-1: #f5f5f7;
            --bg-gradient-2: #e8e8ed;
            --bg-gradient-3: #fafafa;
            --bg-gradient-4: #ffffff;

            --card-bg: rgba(255, 255, 255, 0.72);
            --card-bg-gradient: linear-gradient(135deg, rgba(255, 255, 255, 0.72) 0%, rgba(251, 251, 253, 0.72) 100%);
            --card-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
            --card-hover-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);

            --primary-gradient: linear-gradient(135deg, #1d1d1f 0%, #424245 100%);
            --secondary-gradient: linear-gradient(135deg, #6e6e73 0%, #86868b 100%);
            --accent-gradient: linear-gradient(135deg, #0071e3 0%, #0077ed 100%);
            --success-gradient: linear-gradient(135deg, #30d158 0%, #32d159 100%);
            --danger-gradient: linear-gradient(135deg, #ff3b30 0%, #ff453a 100%);

            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-light: #86868b;

            --border-color: rgba(0, 0, 0, 0.1);
            --border-glow: rgba(0, 0, 0, 0.2);

            --input-bg: rgba(255, 255, 255, 0.8);
            --input-focus-bg: rgba(255, 255, 255, 1);

            --success-bg: rgba(48, 209, 88, 0.1);
            --success-text: #30d158;

            --preview-bg: linear-gradient(135deg, rgba(242, 242, 247, 0.6) 0%, rgba(250, 250, 250, 0.6) 100%);
        }

        /* 深色主题 - Apple风格 */
        body.dark-theme {
            --bg-gradient-1: #000000;
            --bg-gradient-2: #1c1c1e;
            --bg-gradient-3: #2c2c2e;
            --bg-gradient-4: #1d1d1f;

            --card-bg: rgba(28, 28, 30, 0.72);
            --card-bg-gradient: linear-gradient(135deg, rgba(28, 28, 30, 0.72) 0%, rgba(44, 44, 46, 0.72) 100%);
            --card-shadow: 0 2px 16px rgba(0, 0, 0, 0.6);
            --card-hover-shadow: 0 4px 24px rgba(0, 0, 0, 0.8);

            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --text-light: #86868b;

            --border-color: rgba(255, 255, 255, 0.15);
            --border-glow: rgba(255, 255, 255, 0.25);

            --input-bg: rgba(58, 58, 60, 0.5);
            --input-focus-bg: rgba(58, 58, 60, 0.8);

            --success-bg: rgba(48, 209, 88, 0.15);
            --success-text: #30d158;

            --preview-bg: linear-gradient(135deg, rgba(44, 44, 46, 0.4) 0%, rgba(58, 58, 60, 0.4) 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 50%, var(--bg-gradient-3) 75%, var(--bg-gradient-4) 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
            transition: all 0.5s ease;
        }

        /* 背景动画粒子 - Apple风格更加微妙 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(0, 113, 227, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 0, 0, 0.02) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .dark-theme::before {
            background-image:
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.02) 0%, transparent 50%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* 控制栏 - 主题和语言切换 */
        .controls-bar {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            gap: 12px;
        }

        /* 主题切换器 */
        .theme-toggle,
        .lang-toggle {
            display: flex;
            gap: 4px;
            background: var(--card-bg-gradient);
            padding: 4px;
            border-radius: 50px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
        }

        .theme-btn,
        .lang-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .theme-btn.active,
        .lang-btn.active {
            background: var(--input-bg);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .theme-btn:hover:not(.active),
        .lang-btn:hover:not(.active) {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }

        .dark-theme .theme-btn:hover:not(.active),
        .dark-theme .lang-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        /* 头部样式 */
        .header {
            text-align: center;
            margin-bottom: 48px;
            animation: fadeInDown 0.8s ease;
        }

        .header-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
            animation: float 3s ease-in-out infinite;
        }

        .header-svg {
            width: 60px;
            height: 60px;
            filter: drop-shadow(0 8px 16px rgba(102, 126, 234, 0.25));
            transition: transform 0.3s ease;
        }

        .header-svg:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .dark-theme .header-svg {
            filter: drop-shadow(0 8px 16px rgba(255, 255, 255, 0.15));
        }

        .header h1 {
            font-size: 48px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 12px;
            letter-spacing: -1px;
        }

        .header p {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* 卡片样式 */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            /* 统一间距增加到 48px，比例更美观 */
            margin-bottom: 48px;
        }

        .card {
            background: var(--card-bg-gradient);
            border-radius: 32px;
            --card-padding: 36px;
            padding: var(--card-padding);
            box-shadow: var(--card-shadow);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.8s ease;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:hover {
            box-shadow: var(--card-hover-shadow);
            transform: translateY(-4px);
        }

        .card-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 28px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dark-theme .card-title {
            background: linear-gradient(135deg, #f5f5f7 0%, #ffffff 50%, #e5e5e7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
        }

        /* 比例选择区域 */
        .ratio-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 28px;
        }

        .ratio-btn {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 24px 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .ratio-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.2), transparent);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .ratio-btn:hover::before {
            width: 200%;
            height: 200%;
        }

        .ratio-btn:hover {
            border-color: var(--border-glow);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .ratio-btn.active {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .ratio-value {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 6px;
            position: relative;
            z-index: 1;
        }

        .ratio-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .ratio-btn.active .ratio-label {
            color: rgba(255, 255, 255, 0.9);
        }

        /* 自定义比例 */
        .custom-ratio {
            padding: 24px;
            background: var(--preview-bg);
            border-radius: 20px;
            border: 2px dashed var(--border-color);
            transition: all 0.3s ease;
        }

        .custom-ratio:hover {
            border-color: var(--border-glow);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .custom-ratio-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .custom-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .custom-input-group input {
            flex: 1;
            min-width: 0;
            max-width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .custom-input-group input:focus {
            outline: none;
            border-color: var(--border-glow);
            background: var(--input-focus-bg);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .custom-input-group .separator {
            font-size: 28px;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 预览区域 */
        .preview-card {
            text-align: center;
            display: flex;
            flex-direction: column;
        }

        .preview-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 28px;
        }

        .preview-container {
            flex: 1;
            background: var(--preview-bg);
            border-radius: 24px;
            padding: 60px 24px;
            margin-bottom: 28px;
            min-height: 360px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .preview-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.05) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        .preview-box {
            border: 3px dashed var(--text-primary);
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            animation: pulse 3s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }

        .dark-theme .preview-box {
            background: rgba(58, 58, 60, 0.6);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(255, 255, 255, 0.1);
        }

        .preview-ratio-text {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .preview-description {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* 结果显示 */
        .result-display {
            background: var(--success-gradient);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(67, 233, 123, 0.3);
        }

        .result-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .result-value {
            font-size: 30px;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* 计算区域 */
        .calculator-section {
            grid-column: span 2;
        }

        .current-ratio {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 28px;
            padding: 20px;
            background: var(--preview-bg);
            border-radius: 16px;
            border-left: 5px solid;
            border-image: var(--primary-gradient) 1;
            font-weight: 600;
        }

        .dark-theme .current-ratio {
            color: var(--text-primary);
            border-image: linear-gradient(135deg, #f5f5f7 0%, #e5e5e7 100%) 1;
        }

        .current-ratio-value {
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dark-theme .current-ratio-value {
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .input-groups {
            display: grid;
            gap: 28px;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: end;
        }

        .input-field {
            position: relative;
        }

        .input-field label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .input-field input {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .input-field input::placeholder {
            color: var(--text-light);
        }

        .input-field input:focus {
            outline: none;
            border-color: var(--border-glow);
            background: var(--input-focus-bg);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .input-field input.calculated {
            background: var(--success-gradient);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(67, 233, 123, 0.3);
        }

        .input-field input.calculated::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .arrow-icon {
            font-size: 28px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
            margin-bottom: 8px;
        }

        /* 清空按钮 */
        .clear-btn {
            width: 100%;
            padding: 18px;
            background: var(--danger-gradient);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-top: 28px;
            box-shadow: 0 4px 16px rgba(250, 112, 154, 0.3);
            position: relative;
            overflow: hidden;
        }

        .clear-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .clear-btn:hover::before {
            width: 300%;
            height: 300%;
        }

        .clear-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(250, 112, 154, 0.5);
        }

        .clear-btn:active {
            transform: translateY(-2px);
        }

        /* 使用说明 */
        .instructions {
            grid-column: span 2;
            /* 确保在网格中占满两列 */
            background: var(--card-bg-gradient);
            border-radius: 32px;
            padding: 36px;
            box-shadow: var(--card-shadow);
            animation: fadeInUp 1s ease;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .instructions h3 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            background: var(--secondary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dark-theme .instructions h3 {
            background: linear-gradient(135deg, #f5f5f7 0%, #ffffff 50%, #e5e5e7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.2));
        }

        .instructions p {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.8;
            margin-bottom: 12px;
            font-weight: 500;
        }

        /* 动画 */
        @keyframes gradientFlow {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.03);
            }
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* 图像裁切样式 */
        /* 裁切层级与缩放 */
        .crop-canvas-wrapper {
            position: relative;
            max-width: 100%;
            width: fit-content;
            margin: 0 auto 24px auto;
            border-radius: 12px;
            overflow: auto;
            background: #000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: move;
            touch-action: none;
        }

        .crop-box {
            position: absolute;
            border: 2px solid #fff;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(0, 0, 0, 0.3);
            cursor: move;
            z-index: 5;
            touch-action: none;
        }

        /* 圆角控制点 - 边缘箭头样式 */
        .corner-radius-handle {
            position: absolute;
            width: 24px;
            height: 24px;
            background: rgba(0, 113, 227, 0.9);
            border: 2px solid #fff;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 15;
            cursor: pointer;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            transition: transform 0.2s ease, background 0.2s ease;
        }

        .corner-radius-handle::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .corner-radius-handle-top {
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .corner-radius-handle-top::before {
            border-width: 0 4px 6px 4px;
            border-color: transparent transparent white transparent;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -20%);
        }

        .corner-radius-handle-right {
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .corner-radius-handle-right::before {
            border-width: 4px 6px 4px 0;
            border-color: transparent white transparent transparent;
            top: 50%;
            left: 50%;
            transform: translate(-20%, -50%);
        }

        .corner-radius-handle-bottom {
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
        }

        .corner-radius-handle-bottom::before {
            border-width: 6px 4px 0 4px;
            border-color: white transparent transparent transparent;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -80%);
        }

        .corner-radius-handle-left {
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .corner-radius-handle-left::before {
            border-width: 4px 0 4px 6px;
            border-color: transparent transparent transparent white;
            top: 50%;
            left: 50%;
            transform: translate(-80%, -50%);
        }

        .rotation-controls,
        .border-radius-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--input-bg);
            border-radius: 16px;
        }

        .control-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
            min-width: 70px;
        }

        .control-slider {
            flex: 1;
            accent-color: var(--primary-color);
        }

        .control-input {
            width: 70px;
            padding: 8px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .zoom-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 12px;
            width: 48px;
            text-align: center;
            outline: none;
            font-family: inherit;
        }

        .zoom-btn-small {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Toast Message */
        .toast-message {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .toast-message.show {
            opacity: 1;
        }

        .image-crop-section {
            grid-column: span 2;
        }

        .upload-area {
            position: relative;
            /* 移除 min-height: 400px，让容器随内容（如裁切框）自动收缩 */
            width: 100%;
        }

        .upload-placeholder {
            text-align: center;
            padding: 60px 20px;
            background: var(--preview-bg);
            border: 3px dashed var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 380px;
            /* 将最小高度移动到占位符上 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-placeholder:hover {
            border-color: var(--border-glow);
            background: var(--input-focus-bg);
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 72px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        .upload-text {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .upload-btn {
            padding: 16px 40px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.5);
        }

        .crop-container {
            animation: fadeIn 0.5s ease;
        }

        .crop-canvas-wrapper {
            position: relative;
            /* 突破父级 padding 限制，撑满整个卡片宽度 */
            margin-left: calc(var(--card-padding) * -1);
            margin-right: calc(var(--card-padding) * -1);
            width: calc(100% + var(--card-padding) * 2);
            max-width: none;

            margin-bottom: 24px;
            /* 移除自身的圆角，依靠卡片的 overflow:hidden 来裁切圆角，或者保留直角 */
            border-radius: 0;
            overflow: hidden;
            background: #000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .crop-canvas-wrapper::-webkit-scrollbar {
            display: none;
        }

        #cropCanvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: move;
        }

        .crop-box {
            position: absolute;
            border: 2px solid #fff;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(0, 0, 0, 0.3);
            cursor: move;
        }

        .crop-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border: 2px solid #667eea;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .crop-handle-nw {
            top: -8px;
            left: -8px;
            cursor: nw-resize;
        }

        .crop-handle-ne {
            top: -8px;
            right: -8px;
            cursor: ne-resize;
        }

        .crop-handle-sw {
            bottom: -8px;
            left: -8px;
            cursor: sw-resize;
        }

        .crop-handle-se {
            bottom: -8px;
            right: -8px;
            cursor: se-resize;
        }

        .crop-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .crop-grid-line {
            position: absolute;
            background: rgba(255, 255, 255, 0.25);
        }

        .crop-grid-v {
            width: 1px;
            height: 100%;
            top: 0;
        }

        .crop-grid-v:nth-child(1) {
            left: 33.333%;
        }

        .crop-grid-v:nth-child(2) {
            left: 66.666%;
        }

        .crop-grid-h {
            width: 100%;
            height: 1px;
            left: 0;
        }

        .crop-grid-h:nth-child(3) {
            top: 33.333%;
        }

        .crop-grid-h:nth-child(4) {
            top: 66.666%;
        }

        .crop-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .crop-controls .crop-action-btn {
            min-width: 140px;
            padding: 12px 20px;
            font-size: 14px;
        }

        .crop-action-btn {
            flex: 1;
            min-width: 150px;
            padding: 16px 24px;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .crop-btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .crop-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.5);
        }

        .crop-btn-secondary {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 16px rgba(79, 172, 254, 0.3);
        }

        .crop-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(79, 172, 254, 0.5);
        }

        .crop-btn-danger {
            background: var(--danger-gradient);
            color: white;
            box-shadow: 0 4px 16px rgba(250, 112, 154, 0.3);
        }

        .crop-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(250, 112, 154, 0.5);
        }

        .crop-btn-success {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 4px 16px rgba(67, 233, 123, 0.3);
        }

        .crop-btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(67, 233, 123, 0.5);
        }

        .crop-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px;
            background: var(--preview-bg);
            border-radius: 16px;
        }

        .crop-info-item {
            text-align: center;
        }

        .crop-info-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 600;
        }

        .dark-theme .crop-info-label {
            color: var(--text-primary);
            opacity: 0.9;
        }

        .crop-info-value {
            display: block;
            font-size: 18px;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dark-theme .crop-info-value {
            background: linear-gradient(135deg, #ffffff 0%, #f5f5f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.2));
        }

        .crop-result {
            grid-column: span 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* 确保子项整体居中 */
        }

        .crop-result-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 24px;
            background: var(--success-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            width: 100%;
        }

        .crop-result-preview {
            background: var(--preview-bg);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            width: 100%;
            /* 撑满容器 */
        }

        #resultCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .crop-result-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* 开发者社交信息卡片 */
        .developer-card {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 1000;
            background: var(--card-bg-gradient);
            border-radius: 24px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 280px;
        }

        .developer-card:hover {
            box-shadow: var(--card-hover-shadow);
            transform: translateY(-2px);
        }

        .dev-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .dev-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            object-fit: cover;
            transition: all 0.3s ease;
        }

        .dev-avatar:hover {
            transform: scale(1.1);
            border-color: var(--border-glow);
        }

        .dev-info {
            flex: 1;
        }

        .dev-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .dev-title {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .social-links {
            display: grid;
            gap: 8px;
        }

        .social-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--input-bg);
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
        }

        .social-link:hover {
            background: var(--accent-gradient);
            color: white;
            transform: translateX(4px);
            border-color: rgba(0, 113, 227, 0.3);
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.2);
        }

        .social-icon {
            font-size: 18px;
            flex-shrink: 0;
        }

        .social-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 微信二维码弹窗 */
        .qr-trigger {
            cursor: pointer;
            position: relative;
        }

        .qr-popup {
            display: none;
            position: absolute;
            left: 100%;
            top: 0;
            margin-left: 12px;
            background: var(--card-bg-gradient);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-hover-shadow);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }

        .qr-trigger:hover .qr-popup {
            display: block;
        }

        .qr-image {
            width: 180px;
            height: 180px;
            border-radius: 12px;
            display: block;
        }

        .qr-label {
            text-align: center;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* 收起/展开按钮 */
        .dev-toggle {
            text-align: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .developer-card.collapsed {
            max-width: 90px;
            padding: 16px;
        }

        .developer-card.collapsed .dev-header {
            flex-direction: column;
            margin-bottom: 0;
        }

        .developer-card.collapsed .dev-info,
        .developer-card.collapsed .social-links,
        .developer-card.collapsed .dev-toggle {
            display: none;
        }

        .developer-card.collapsed .dev-avatar {
            width: 56px;
            height: 56px;
        }

        /* 响应式 */
        @media (max-width: 968px) {
            .controls-bar {
                top: 20px;
                right: 20px;
            }

            .developer-card {
                top: 20px;
                left: 20px;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .calculator-section {
                grid-column: span 1;
            }

            .ratio-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 36px;
            }
        }

        @media (max-width: 640px) {
            .theme-toggle {
                top: 15px;
                right: 15px;
            }

            .theme-btn {
                padding: 10px 16px;
                font-size: 12px;
            }

            .header h1 {
                font-size: 32px;
            }

            .card {
                --card-padding: 24px;
                padding: var(--card-padding);
                border-radius: 24px;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .arrow-icon {
                transform: rotate(90deg);
            }
        }

        /* 图片拼接样式 */
        .stitch-container {
            padding: 24px;
        }

        .stitch-options {
            margin-bottom: 24px;
        }

        .stitch-mode-group {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stitch-mode-label {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stitch-mode-options {
            display: flex;
            gap: 12px;
        }

        .stitch-mode-option {
            cursor: pointer;
        }

        .stitch-mode-option input {
            display: none;
        }

        .stitch-mode-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stitch-mode-btn small {
            font-size: 11px;
            opacity: 0.7;
            font-weight: 500;
        }

        .stitch-mode-btn .stitch-icon {
            font-size: 18px;
        }

        .stitch-mode-option input:checked+.stitch-mode-btn {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .stitch-mode-option:hover .stitch-mode-btn:not(input:checked + *) {
            border-color: var(--border-glow);
            background: var(--input-focus-bg);
        }

        .stitch-image-list {
            display: flex;
            gap: 16px;
            padding: 20px;
            background: var(--preview-bg);
            border-radius: 20px;
            min-height: 120px;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .stitch-image-item {
            position: relative;
            flex-shrink: 0;
            animation: fadeIn 0.4s ease;
        }

        .stitch-image-thumb {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 12px;
            border: 3px solid var(--border-color);
            cursor: grab;
            transition: all 0.3s ease;
        }

        /* 仅在支持 Hover 的设备（PC）上启用悬停效果 */
        @media (hover: hover) {
            .stitch-image-thumb:hover {
                border-color: var(--border-glow);
                transform: scale(1.05);
            }
        }

        .stitch-image-thumb.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .stitch-image-info {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg-gradient);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
        }

        .stitch-image-remove {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 28px;
            height: 28px;
            background: var(--danger-gradient);
            border: 2px solid var(--card-bg);
            border-radius: 50%;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0;
        }

        @media (hover: hover) {
            .stitch-image-item:hover .stitch-image-remove {
                opacity: 1;
            }

            .stitch-image-remove:hover {
                transform: scale(1.15);
            }
        }

        /* 移动端/触摸屏优化：始终显示删除按钮，禁用Hover干扰 */
        @media (hover: none) {
            .stitch-image-remove {
                opacity: 1 !important;
                background: rgba(255, 59, 48, 0.9);
                width: 28px;
                /* 稍微加大触摸区域 */
                height: 28px;
            }
        }

        .stitch-image-order {
            position: absolute;
            top: -10px;
            left: -10px;
            width: 28px;
            height: 28px;
            background: var(--accent-gradient);
            border: 2px solid var(--card-bg);
            border-radius: 50%;
            color: white;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stitch-preview-info {
            margin-top: 20px;
            padding: 16px 20px;
            background: var(--success-bg);
            border-radius: 16px;
            text-align: center;
        }

        .stitch-preview-text {
            font-size: 15px;
            font-weight: 600;
            color: var(--success-text);
        }

        .stitch-preview-text span {
            font-weight: 800;
            font-size: 18px;
        }

        .stitch-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 32px;
            width: 100%;
            flex-wrap: wrap;
        }

        /* 针对拼接动作按钮的微调 */
        .stitch-actions .crop-action-btn {
            min-width: 140px;
            padding: 12px 20px;
            font-size: 14px;
        }

        @media (min-width: 768px) {
            .stitch-actions {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stitch-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            color: var(--text-light);
            font-size: 14px;
            font-weight: 500;
        }

        .stitch-placeholder-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .stitch-image-item.selected .stitch-image-thumb {
            border-color: var(--primary-gradient);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }

        .stitch-image-item.selected .stitch-image-order {
            background: var(--primary-gradient);
        }

        .stitch-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--text-light);
            font-weight: 800;
        }

        /* 拼接预览容器 */
        .stitch-preview-container {
            margin-bottom: 24px;
            padding: 20px;
            background: var(--preview-bg);
            border-radius: 20px;
            border: 2px solid var(--border-color);
        }

        .stitch-preview-label {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-align: center;
        }

        .stitch-preview-canvas {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            background: var(--card-bg);
        }

        /* 小上传框 */
        .upload-placeholder-small {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: var(--input-bg);
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-placeholder-small:hover {
            border-color: var(--border-glow);
            background: var(--input-focus-bg);
        }

        .upload-icon-small {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .upload-text-small {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .upload-btn-small {
            padding: 8px 20px;
            background: var(--primary-gradient);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* 移动端专属优化 - 解决遮挡和拥挤问题 */
        @media (max-width: 968px) {
            body {
                display: flex;
                /* 改为 Flex 布局以调整顺序 */
                flex-direction: column;
                padding: 0;
                /* 接管 padding */
                background-attachment: fixed;
            }

            /* 1. 调整控制栏 (主题/语言切换) */
            /* 移至顶部文档流，不再悬浮遮挡 */
            .controls-bar {
                position: static;
                order: 0;
                width: 100%;
                justify-content: flex-end;
                /* 居右显示 */
                padding: 16px 24px;
                background: transparent;
                height: auto;
                margin-bottom: 0;
            }

            /* 2. 主内容区域 */
            .container {
                order: 1;
                width: 100%;
                max-width: 100%;
                padding: 10px 20px 40px 20px;
                margin: 0;
            }

            /* 3. 开发者卡片 - 移至底部 Footer */
            .developer-card {
                position: static;
                order: 2;
                /* 放在最底部 */
                width: 100%;
                max-width: 100%;
                margin: 20px 0 0 0;
                border-radius: 0;
                border: none;
                border-top: 1px solid var(--border-color);
                background: var(--card-bg-gradient);
                box-shadow: none;
                padding: 32px 24px 60px 24px;
                /* 底部留多一点空间 */
            }

            /* 移动端强制展开开发者信息，并不再支持收起（因为已经在底部了） */
            .developer-card.collapsed {
                max-width: 100%;
                padding: 32px 24px 60px 24px;
            }

            .developer-card .dev-toggle {
                display: none !important;
            }

            .developer-card.collapsed .dev-info,
            .developer-card.collapsed .social-links {
                display: block !important;
            }

            .developer-card.collapsed .dev-header {
                flex-direction: row;
                margin-bottom: 16px;
            }

            /* 社交链接横向自适应排列 */
            .social-links {
                display: grid !important;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 12px;
            }

            /* 4. 解决模块拥挤问题 */
            .main-content {
                display: flex;
                flex-direction: column;
                gap: 32px;
                /* 增加模块间距 */
                margin-bottom: 0;
            }

            .card {
                padding: 24px 20px;
                /* 调整卡片内边距 */
            }

            /* 输入框组优化 */
            .input-row {
                gap: 16px;
            }

            /* 头部字体自适应 */
            .header {
                margin-bottom: 32px;
                padding: 0 10px;
            }

            .header h1 {
                font-size: 32px;
            }


            /* 比例选择按钮优化 */
            .ratio-grid {
                gap: 12px;
            }

            .ratio-btn {
                padding: 16px 8px;
                /* 减小内边距 */
            }

            /* 裁切区域优化 */
            .file-upload-label {
                padding: 40px 20px;
            }

            /* 预览和结果区域优化 padding */
            .crop-container,
            .stitch-container {
                padding: 16px;
            }

            /* 修正移动端二维码弹窗位置 - 显示在上方居中 */
            .qr-popup {
                left: 50% !important;
                top: auto !important;
                bottom: 100% !important;
                margin-left: 0 !important;
                margin-bottom: 12px;
                transform: translateX(-50%);
                z-index: 100;
            }

            /* 5. 按钮组优化 - 修复溢出和对齐问题 */
            /* 统一将所有主要操作区域改为双列网格布局，确保排版整齐且不溢出 */
            .crop-result-actions,
            .crop-controls,
            .stitch-actions {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                /* 强制两列 */
                gap: 12px;
                width: 100%;
                justify-content: stretch;
                flex-wrap: wrap !important;
                /* 覆盖可能存在的flex-wrap */
            }

            /* 按钮样式复写：填满网格单元，高度拉伸对齐 */
            .crop-action-btn,
            .stitch-actions .crop-action-btn {
                min-width: 0 !important;
                /* 解除最小宽度限制 */
                width: 100% !important;
                padding: 12px 6px;
                /* 稍微减小Padding以防文字太多 */
                height: 100%;
                /* 确保在Grid中占满高度，实现等高 */
                white-space: normal;
                /* 允许文字换行 */
                line-height: 1.3;
                text-align: center;
            }

            /* 拼接模式选项优化 */
            .stitch-mode-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                width: 100%;
            }

            .stitch-mode-options {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .stitch-mode-btn {
                justify-content: center;
                width: 100%;
                text-align: center;
                /* 改为垂直堆叠，解决文字挤压难看的问题 */
                flex-direction: column !important;
                gap: 6px;
                padding: 14px 8px;
            }

            .stitch-mode-btn .stitch-icon {
                font-size: 22px;
                margin-bottom: 2px;
            }

            .stitch-mode-btn>span:not(.stitch-icon) {
                white-space: nowrap;
                /* 防止 "左右拼接" 换行 */
            }

            .stitch-mode-btn small {
                white-space: nowrap;
                /* 防止 "(高度对齐)" 换行 */
                display: block;
            }
        }

        @media (max-width: 640px) {
            .controls-bar {
                justify-content: center;
                /* 手机端居中可能更好看 */
                padding: 12px 16px;
            }

            .header h1 {
                font-size: 28px;
            }

            /* 再次微调小屏幕的间距 */
            .ratio-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <!-- 开发者社交信息卡片 -->
    <div class="developer-card" id="devCard">
        <div class="dev-header">
            <img src="avatar.png" alt="ToolBuddy" class="dev-avatar" id="devAvatar">
            <div class="dev-info">
                <div class="dev-name" data-i18n="developer.name">工具狂</div>
                <div class="dev-title" data-i18n="developer.title">Developer</div>
            </div>
        </div>

        <div class="social-links">
            <a href="https://www.youtube.com/@crazytoolman" target="_blank" class="social-link">
                <span class="social-icon">▶️</span>
                <span class="social-text">YouTube</span>
            </a>

            <a href="https://space.bilibili.com/33410454" target="_blank" class="social-link">
                <span class="social-icon">📺</span>
                <span class="social-text">Bilibili</span>
            </a>

            <a href="https://v.douyin.com/ik9R5bMW" target="_blank" class="social-link">
                <span class="social-icon">🎵</span>
                <span class="social-text" data-i18n="developer.douyin">抖音</span>
            </a>

            <div class="social-link qr-trigger">
                <span class="social-icon">💬</span>
                <span class="social-text" data-i18n="developer.wechat">微信公众号</span>
                <div class="qr-popup">
                    <img src="wechat_qr.png" alt="WeChat QR" class="qr-image" id="wechatQR">
                    <div class="qr-label" data-i18n="developer.scanQR">扫码关注</div>
                </div>
            </div>

            <div class="social-link" style="cursor: default; background: var(--preview-bg);">
                <span class="social-icon">👤</span>
                <span class="social-text" style="font-size: 12px;">crazytoolman</span>
            </div>
        </div>

        <div class="dev-toggle">
            <button class="toggle-btn" id="toggleDevCard" data-i18n="developer.collapse">收起</button>
        </div>
    </div>

    <!-- 控制栏 - 主题和语言 -->
    <div class="controls-bar">
        <!-- 主题切换器 -->
        <div class="theme-toggle">
            <button class="theme-btn active" data-theme="light">
                ☀️ <span data-i18n="theme.light">浅色</span>
            </button>
            <button class="theme-btn" data-theme="dark">
                🌙 <span data-i18n="theme.dark">深色</span>
            </button>
        </div>
        <!-- 语言切换器 -->
        <div class="lang-toggle">
            <button class="lang-btn active" data-lang="zh">
                中文
            </button>
            <button class="lang-btn" data-lang="en">
                English
            </button>
        </div>
    </div>

    <div class="container">
        <!-- 头部 -->
        <div class="header">
            <div class="header-icon">
                <!-- 比例图标 -->
                <svg class="header-svg" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="icon-grad-1" x1="0" y1="0" x2="48" y2="48" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#0066FF" />
                            <stop offset="100%" stop-color="#5AC8FA" />
                        </linearGradient>
                    </defs>
                    <rect x="8" y="8" width="32" height="32" rx="6" stroke="url(#icon-grad-1)" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16 32L32 16" stroke="url(#icon-grad-1)" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M32 16H24" stroke="url(#icon-grad-1)" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M32 16V24" stroke="url(#icon-grad-1)" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M16 32H24" stroke="url(#icon-grad-1)" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M16 32V24" stroke="url(#icon-grad-1)" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>

                <!-- 裁切图标 -->
                <svg class="header-svg" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="icon-grad-2" x1="48" y1="0" x2="0" y2="48" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#FF2D55" />
                            <stop offset="100%" stop-color="#FF9500" />
                        </linearGradient>
                    </defs>
                    <path d="M12 38V12C12 9.79086 13.7909 8 16 8H40" stroke="url(#icon-grad-2)" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M36 10V36C36 38.2091 34.2091 40 32 40H8" stroke="url(#icon-grad-2)" stroke-width="3"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 14V6" stroke="url(#icon-grad-2)" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M42 8H34" stroke="url(#icon-grad-2)" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M6 40H14" stroke="url(#icon-grad-2)" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <path d="M36 34V42" stroke="url(#icon-grad-2)" stroke-width="3" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>

                <!-- 拼接图标 -->
                <svg class="header-svg" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="icon-grad-3" x1="0" y1="48" x2="48" y2="0" gradientUnits="userSpaceOnUse">
                            <stop offset="0%" stop-color="#AF52DE" />
                            <stop offset="100%" stop-color="#5856D6" />
                        </linearGradient>
                    </defs>
                    <!-- 左侧图片框 -->
                    <rect x="4" y="12" width="16" height="24" rx="3" stroke="url(#icon-grad-3)" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <!-- 右侧图片框 -->
                    <rect x="28" y="12" width="16" height="24" rx="3" stroke="url(#icon-grad-3)" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round" />
                    <!-- 中间连接虚线 -->
                    <path d="M22 24H26" stroke="url(#icon-grad-3)" stroke-width="2.5" stroke-linecap="round"
                        stroke-dasharray="1 3" />
                    <!-- 合并箭头 - 左 -->
                    <path d="M20 20L23 24L20 28" stroke="url(#icon-grad-3)" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                    <!-- 合并箭头 - 右 -->
                    <path d="M28 20L25 24L28 28" stroke="url(#icon-grad-3)" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
            </div>
            <h1 data-i18n="header.title">比例计算器 & 图像裁切拼接工具</h1>
            <p data-i18n="header.subtitle">智能计算尺寸比例，精确裁切与拼接您的图片</p>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 图像裁切 -->
            <div class="card image-crop-section">
                <h2 class="card-title" data-i18n="imageCrop.title">✂️ 图像裁切工具</h2>

                <!-- 上传区域 -->
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;">
                    <div class="upload-placeholder" id="uploadPlaceholder">
                        <div class="upload-icon">📤</div>
                        <div class="upload-text" data-i18n="imageCrop.uploadText">点击上传、拖拽或粘贴图片到这里</div>
                        <div class="upload-hint" data-i18n="imageCrop.uploadHint">支持 JPG、PNG、GIF 等格式（可粘贴多张）</div>
                        <button class="upload-btn" id="uploadBtn" data-i18n="imageCrop.uploadBtn">选择图片</button>
                    </div>

                    <!-- 图片拼接区域 -->
                    <div class="stitch-container" id="stitchContainer" style="display: none;">
                        <!-- 拼接模式选择 -->
                        <div class="stitch-options">
                            <div class="stitch-mode-group">
                                <label class="stitch-mode-label" data-i18n="stitch.mode">拼接方式：</label>
                                <div class="stitch-mode-options">
                                    <label class="stitch-mode-option">
                                        <input type="radio" name="stitchMode" value="horizontal" checked>
                                        <span class="stitch-mode-btn">
                                            <span class="stitch-icon">⬌</span>
                                            <span data-i18n="stitch.horizontal">左右拼接</span>
                                            <small data-i18n="stitch.horizontalHint">(高度对齐)</small>
                                        </span>
                                    </label>
                                    <label class="stitch-mode-option">
                                        <input type="radio" name="stitchMode" value="vertical">
                                        <span class="stitch-mode-btn">
                                            <span class="stitch-icon">⬍</span>
                                            <span data-i18n="stitch.vertical">上下拼接</span>
                                            <small data-i18n="stitch.verticalHint">(宽度对齐)</small>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 实时拼接预览 -->
                        <div class="stitch-preview-container">
                            <div class="stitch-preview-label" data-i18n="stitch.previewLabel">拼接预览</div>
                            <canvas id="stitchPreviewCanvas" class="stitch-preview-canvas"></canvas>
                            <div class="stitch-preview-info" id="stitchPreviewInfo"></div>
                        </div>

                        <!-- 图片列表 -->
                        <div class="stitch-image-list" id="stitchImageList"></div>

                        <!-- 上传框（在图片列表下方） -->
                        <div class="upload-placeholder-small" id="uploadPlaceholderSmall">
                            <div class="upload-icon-small">📤</div>
                            <div class="upload-text-small" data-i18n="imageCrop.uploadTextSmall">继续添加图片</div>
                            <button class="upload-btn-small" id="uploadBtnSmall"
                                data-i18n="imageCrop.uploadBtn">选择图片</button>
                        </div>

                        <!-- 拼接按钮 -->
                        <div class="stitch-actions">
                            <button class="crop-action-btn crop-btn-primary" id="stitchBtn">
                                <span>🔗 </span><span data-i18n="stitch.stitchBtn">拼接图片</span>
                            </button>
                            <button class="crop-action-btn crop-btn-success" id="downloadStitchBtn">
                                <span>📥 </span><span data-i18n="stitch.downloadBtn">直接下载拼接图</span>
                            </button>
                            <button class="crop-action-btn crop-btn-primary" id="copyStitchBtn">
                                <span>📋 </span><span data-i18n="stitch.copyBtn">直接复制拼接图</span>
                            </button>
                            <button class="crop-action-btn crop-btn-secondary" id="preCropBtn" style="display: none;">
                                <span>✂️ </span><span data-i18n="stitch.preCropBtn">预裁切选中项</span>
                            </button>
                            <button class="crop-action-btn crop-btn-danger" id="clearStitchBtn">
                                <span>🗑️ </span><span data-i18n="stitch.clearBtn">清空图片</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 裁切区域 -->
                <div class="crop-container" id="cropContainer" style="display: none;">
                    <div class="crop-canvas-wrapper">
                        <!-- Zoom Controls Header -->
                        <div class="zoom-controls-header"
                            style="width: 100%; display: flex; justify-content: flex-end; align-items: center; gap: 8px; padding: 10px 16px; box-sizing: border-box; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <button id="zoomOutBtn" class="zoom-btn-small" title="Zoom Out">-</button>
                            <input type="number" id="zoomInput" class="zoom-input" value="100" min="10" max="5000">
                            <span style="color: white; font-size: 12px; margin-right: 4px;">%</span>
                            <button id="zoomInBtn" class="zoom-btn-small" title="Zoom In">+</button>
                        </div>
                        <div class="crop-content-layer" style="position: relative; width: fit-content; margin: 0 auto;">
                            <canvas id="cropCanvas"></canvas>
                            <div class="crop-overlay" id="cropOverlay">
                                <div class="crop-box" id="cropBox">
                                    <div class="crop-handle crop-handle-nw"></div>
                                    <div class="crop-handle crop-handle-ne"></div>
                                    <div class="crop-handle crop-handle-sw"></div>
                                    <div class="crop-handle crop-handle-se"></div>
                                    <!-- 圆角控制点 -->
                                    <div class="corner-radius-handle corner-radius-handle-top" data-edge="top"></div>
                                    <div class="corner-radius-handle corner-radius-handle-right" data-edge="right">
                                    </div>
                                    <div class="corner-radius-handle corner-radius-handle-bottom" data-edge="bottom">
                                    </div>
                                    <div class="corner-radius-handle corner-radius-handle-left" data-edge="left"></div>
                                    <div class="crop-grid">
                                        <div class="crop-grid-line crop-grid-v"></div>
                                        <div class="crop-grid-line crop-grid-v"></div>
                                        <div class="crop-grid-line crop-grid-h"></div>
                                        <div class="crop-grid-line crop-grid-h"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="crop-controls">
                        <button class="crop-action-btn crop-btn-primary" id="cropBtn">
                            <span data-i18n="imageCrop.cropBtn">✂️ 裁切图片</span>
                        </button>
                        <button class="crop-action-btn crop-btn-primary" id="applyPreCropBtn" style="display: none;">
                            <span data-i18n="stitch.savePreCrop">应用到列表并返回</span>
                        </button>
                        <button class="crop-action-btn crop-btn-secondary" id="rotateBtn">
                            <span data-i18n="imageCrop.rotate90Btn">🔄 旋转 90°</span>
                        </button>
                        <button class="crop-action-btn crop-btn-secondary" id="cancelStitchBtn" style="display: none;">
                            <span data-i18n="stitch.backToStitch">🔙 撤回并返回列表</span>
                        </button>
                        <button class="crop-action-btn crop-btn-secondary" id="resetCropBtn">
                            <span data-i18n="imageCrop.resetBtn">🔄 重置裁切区域</span>
                        </button>
                        <button class="crop-action-btn crop-btn-danger" id="cancelCropBtn">
                            <span data-i18n="imageCrop.cancelBtn">❌ 取消并重新上传</span>
                        </button>
                    </div>

                    <!-- 高级控制：旋转与圆角 -->
                    <div class="rotation-controls">
                        <span class="control-label" data-i18n="imageCrop.rotateLabel">旋转角度:</span>
                        <input type="range" id="rotationSlider" class="control-slider" min="-180" max="180" value="0">
                        <input type="number" id="rotationInput" class="control-input" min="-180" max="180" value="0">
                        <span class="control-label" style="min-width: unset;">°</span>
                    </div>

                    <div class="border-radius-controls">
                        <span class="control-label" data-i18n="imageCrop.borderRadiusLabel">圆角调节:</span>
                        <input type="range" id="borderRadiusSlider" class="control-slider" min="0" max="250" value="0">
                        <input type="number" id="borderRadiusInput" class="control-input" min="0" max="250" value="0">
                        <span class="control-label" style="min-width: unset;">px</span>
                    </div>

                    <!-- 裁切信息 -->
                    <div class="crop-info">
                        <div class="crop-info-item">
                            <span class="crop-info-label" data-i18n="imageCrop.originalSize">原始尺寸:</span>
                            <span class="crop-info-value" id="originalSize">—</span>
                        </div>
                        <div class="crop-info-item">
                            <span class="crop-info-label" data-i18n="imageCrop.cropArea">裁切区域:</span>
                            <span class="crop-info-value" id="cropSize">—</span>
                        </div>
                        <div class="crop-info-item">
                            <span class="crop-info-label" data-i18n="imageCrop.currentRatio">当前比例:</span>
                            <span class="crop-info-value" id="cropRatio">—</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 裁切结果 -->
            <div class="card crop-result" id="cropResult" style="display: none;">
                <h3 class="crop-result-title" data-i18n="imageCrop.resultTitle">裁切结果预览</h3>
                <div class="crop-result-preview">
                    <canvas id="resultCanvas"></canvas>
                </div>
                <div class="crop-result-actions">
                    <button class="crop-action-btn crop-btn-success" id="savePreCropBtn" style="display: none;">
                        <span>📥 </span><span data-i18n="stitch.savePreCrop">应用到列表</span>
                    </button>
                    <button class="crop-action-btn crop-btn-success" id="downloadBtn">
                        <span data-i18n="imageCrop.downloadBtn">💾 下载图片 (PNG)</span>
                    </button>
                    <button class="crop-action-btn crop-btn-primary" id="copyBtn">
                        <span data-i18n="imageCrop.copyBtn">📋 复制图片</span>
                    </button>
                    <button class="crop-action-btn crop-btn-secondary" id="newCropBtn">
                        <span data-i18n="imageCrop.newCropBtn">🔄 裁切新图片</span>
                    </button>
                </div>
            </div>
            <!-- 之前在这里多了一个闭合标签，已移除 -->

            <!-- 选择比例 -->
            <div class="card">
                <h2 class="card-title" data-i18n="ratioSelect.title">选择比例</h2>

                <div class="ratio-grid">
                    <button class="ratio-btn" data-ratio="2:3">
                        <div class="ratio-value">2:3</div>
                        <div class="ratio-label" data-i18n="ratioSelect.vertical">竖版照片</div>
                    </button>
                    <button class="ratio-btn" data-ratio="3:2">
                        <div class="ratio-value">3:2</div>
                        <div class="ratio-label" data-i18n="ratioSelect.horizontal">横版照片</div>
                    </button>
                    <button class="ratio-btn" data-ratio="1:1">
                        <div class="ratio-value">1:1</div>
                        <div class="ratio-label" data-i18n="ratioSelect.square">正方形</div>
                    </button>
                    <button class="ratio-btn" data-ratio="16:9">
                        <div class="ratio-value">16:9</div>
                        <div class="ratio-label" data-i18n="ratioSelect.widescreen">宽屏</div>
                    </button>
                    <button class="ratio-btn" data-ratio="9:16">
                        <div class="ratio-value">9:16</div>
                        <div class="ratio-label" data-i18n="ratioSelect.portrait">竖屏</div>
                    </button>
                    <button class="ratio-btn" data-ratio="4:3">
                        <div class="ratio-value">4:3</div>
                        <div class="ratio-label" data-i18n="ratioSelect.traditional">传统屏幕</div>
                    </button>
                    <button class="ratio-btn active" data-ratio="3:4">
                        <div class="ratio-value">3:4</div>
                        <div class="ratio-label" data-i18n="ratioSelect.verticalTraditional">竖版传统</div>
                    </button>
                    <button class="ratio-btn" data-ratio="21:9">
                        <div class="ratio-value">21:9</div>
                        <div class="ratio-label" data-i18n="ratioSelect.ultrawide">超宽屏</div>
                    </button>
                    <button class="ratio-btn" data-ratio="1:2">
                        <div class="ratio-value">1:2</div>
                        <div class="ratio-label" data-i18n="ratioSelect.tallImage">竖长图</div>
                    </button>
                    <button class="ratio-btn" data-ratio="4:5">
                        <div class="ratio-value">4:5</div>
                        <div class="ratio-label" data-i18n="ratioSelect.ratio45">4:5</div>
                    </button>
                    <button class="ratio-btn" data-ratio="5:4">
                        <div class="ratio-value">5:4</div>
                        <div class="ratio-label" data-i18n="ratioSelect.miniProgram">小程序封面</div>
                    </button>
                    <button class="ratio-btn" data-ratio="2.35:1">
                        <div class="ratio-value">2.35:1</div>
                        <div class="ratio-label" data-i18n="ratioSelect.wechatCover">微信封面</div>
                    </button>
                </div>

                <div class="custom-ratio">
                    <div class="custom-ratio-title" data-i18n="ratioSelect.custom">自定义比例</div>
                    <div class="custom-input-group">
                        <input type="number" id="customWidth" data-i18n-placeholder="ratioSelect.customWidth"
                            placeholder="宽" min="1">
                        <span class="separator">:</span>
                        <input type="number" id="customHeight" data-i18n-placeholder="ratioSelect.customHeight"
                            placeholder="高" min="1">
                    </div>
                </div>
            </div>

            <!-- 比例预览 -->
            <div class="card preview-card">
                <h2 class="card-title" data-i18n="preview.title">比例预览</h2>
                <p class="preview-subtitle" data-i18n="preview.subtitle">可视化显示当前选择的比例</p>

                <div class="preview-container">
                    <div class="preview-box" id="previewBox">
                        <div class="preview-ratio-text" id="previewRatio">3:4</div>
                        <div class="preview-description" id="previewDesc">3 × 4</div>
                    </div>
                </div>

                <div class="result-display" id="resultDisplay" style="display: none;">
                    <div class="result-label" data-i18n="preview.resultLabel">计算结果</div>
                    <div class="result-value" id="resultValue">—</div>
                </div>
            </div>

            <!-- 尺寸计算 -->
            <div class="card calculator-section">
                <h2 class="card-title" data-i18n="calculator.title">尺寸计算</h2>

                <div class="current-ratio">
                    <span data-i18n="calculator.currentRatio">当前比例：</span><span class="current-ratio-value"
                        id="currentRatioText">3:4</span>
                </div>

                <div class="input-groups">
                    <div class="input-row">
                        <div class="input-field">
                            <label for="inputWidth" data-i18n="calculator.inputWidth">输入宽度</label>
                            <input type="number" id="inputWidth" data-i18n-placeholder="calculator.widthPlaceholder"
                                placeholder="输入宽度数值" step="0.01">
                        </div>
                        <div class="arrow-icon">➜</div>
                        <div class="input-field">
                            <label for="calcHeight" data-i18n="calculator.calcHeight">计算高度</label>
                            <input type="number" id="calcHeight" placeholder="—" class="calculated" readonly>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-field">
                            <label for="inputHeight" data-i18n="calculator.inputHeight">输入高度</label>
                            <input type="number" id="inputHeight" data-i18n-placeholder="calculator.heightPlaceholder"
                                placeholder="输入高度数值" step="0.01">
                        </div>
                        <div class="arrow-icon">➜</div>
                        <div class="input-field">
                            <label for="calcWidth" data-i18n="calculator.calcWidth">计算宽度</label>
                            <input type="number" id="calcWidth" placeholder="—" class="calculated" readonly>
                        </div>
                    </div>
                </div>

                <button class="clear-btn" id="clearBtn" data-i18n="calculator.clearBtn">清空所有输入</button>
            </div>

            <!-- 使用说明 -->
            <div class="card instructions"> <!-- Added 'card' class and implicitly grid-column: span 2 via CSS -->
                <h3 data-i18n="instructions.title">使用说明：</h3>
                <p><strong data-i18n="instructions.ratioCalc">📐 比例计算：</strong><span
                        data-i18n="instructions.ratioCalcDesc">选择预设比例或输入自定义比例,然后在任意一个输入框中输入数值,系统将自动计算另一边的尺寸。</span></p>
                <p><strong data-i18n="instructions.imageCrop">✂️ 图像裁切：</strong><span
                        data-i18n="instructions.imageCropDesc">点击上传或拖拽图片到上传区域,选择合适的比例后,拖动裁切框或调整角落手柄来定位裁切区域,点击"裁切图片"按钮完成裁切,最后可以下载裁切结果。</span>
                </p>
                <p data-i18n="instructions.supported">支持的比例包括常用的照片比例、屏幕比例等,也可以自定义任意比例进行计算和裁切。</p>
            </div>

            <!-- 配置管理 -->
            <div class="card persistence-section" style="grid-column: span 2;">
                <h2 class="card-title" data-i18n="config.title">⚙️ 配置管理</h2>
                <div class="stitch-actions" style="margin-top: 10px;"> <!-- 复用居中样式 -->
                    <button class="crop-action-btn crop-btn-primary" id="saveConfigBtn">
                        <span data-i18n="config.saveBtn">保存当前配置</span>
                    </button>
                    <button class="crop-action-btn crop-btn-danger" id="clearConfigBtn">
                        <span data-i18n="config.clearBtn">清除所有配置并重置</span>
                    </button>
                </div>
            </div>
        </div>

        <script>
            // ========== 国际化系统 ==========
            const translations = {
                zh: {
                    theme: {
                        light: '浅色',
                        dark: '深色'
                    },
                    header: {
                        title: '比例计算器 & 图像裁切拼接工具',
                        subtitle: '智能计算尺寸比例，精确裁切与拼接您的图片'
                    },
                    imageCrop: {
                        title: '✂️ 图像裁切工具',
                        uploadText: '点击上传、拖拽或粘贴图片到这里',
                        uploadHint: '支持 JPG、PNG、GIF 等格式（可粘贴多张）',
                        uploadBtn: '选择图片',
                        cropBtn: '✂️ 裁切图片',
                        rotate90Btn: '🔄 旋转 90°',
                        resetBtn: '🔄 重置裁切区域',
                        cancelBtn: '❌ 取消并重新上传',
                        originalSize: '原始尺寸:',
                        cropArea: '裁切区域:',
                        currentRatio: '裁切比例:',
                        rotateLabel: '旋转角度:',
                        borderRadiusLabel: '圆角调节:',
                        resultTitle: '裁切结果预览',
                        downloadBtn: '💾 下载图片 (PNG)',
                        copyBtn: '📋 复制图片',
                        copiedBtn: '✅ 已复制!',
                        newCropBtn: '🔄 裁切新图片'
                    },
                    stitch: {
                        mode: '拼接方式：',
                        horizontal: '左右拼接',
                        horizontalHint: '(高度对齐)',
                        vertical: '上下拼接',
                        verticalHint: '(宽度对齐)',
                        stitchBtn: '开始裁切流程',
                        clearBtn: '清空列表',
                        placeholder: '粘贴或上传多张图片',
                        previewLabel: '拼接预览',
                        dimensions: '总尺寸：',
                        preCropBtn: '预裁切选中项',
                        savePreCrop: '应用到列表并返回',
                        downloadBtn: '直接下载拼接图',
                        copyBtn: '直接复制拼接图',
                        backToStitch: '🔙 撤回并返回列表',
                        copied: '✅ 已复制！',
                        preview: '张图片'
                    },
                    config: {
                        title: '⚙️ 配置管理',
                        saveBtn: '保存当前配置',
                        clearBtn: '清除所有配置并重置',
                        saveSuccess: '配置已成功保存到本地！',
                        clearConfirm: '确定要清除所有配置并恢复原始状态吗？此操作不可撤销。'
                    },
                    ratioSelect: {
                        title: '选择比例',
                        vertical: '竖版照片',
                        horizontal: '横版照片',
                        square: '正方形',
                        widescreen: '宽屏',
                        portrait: '竖屏',
                        traditional: '传统屏幕',
                        verticalTraditional: '竖版传统',
                        ultrawide: '超宽屏',
                        tallImage: '竖长图',
                        ratio45: '4:5',
                        miniProgram: '小程序封面',
                        wechatCover: '微信封面',
                        custom: '自定义比例',
                        customWidth: '宽',
                        customHeight: '高'
                    },
                    preview: {
                        title: '比例预览',
                        subtitle: '可视化显示当前选择的比例',
                        resultLabel: '计算结果'
                    },
                    calculator: {
                        title: '尺寸计算',
                        currentRatio: '当前比例：',
                        inputWidth: '输入宽度',
                        inputHeight: '输入高度',
                        calcWidth: '计算宽度',
                        calcHeight: '计算高度',
                        widthPlaceholder: '输入宽度数值',
                        heightPlaceholder: '输入高度数值',
                        clearBtn: '清空所有输入'
                    },
                    instructions: {
                        title: '使用说明：',
                        ratioCalc: '📐 比例计算：',
                        ratioCalcDesc: '选择预设比例或输入自定义比例,然后在任意一个输入框中输入数值,系统将自动计算另一边的尺寸。',
                        imageCrop: '✂️ 图像裁切：',
                        imageCropDesc: '点击上传或拖拽图片到上传区域,选择合适的比例后,拖动裁切框或调整角落手柄来定位裁切区域,点击"裁切图片"按钮完成裁切,最后可以下载裁切结果。',
                        supported: '支持的比例包括常用的照片比例、屏幕比例等,也可以自定义任意比例进行计算和裁切。'
                    },
                    developer: {
                        name: '工具狂',
                        title: 'Developer',
                        douyin: '抖音',
                        wechat: '微信公众号',
                        scanQR: '扫码关注',
                        collapse: '收起',
                        expand: '展开'
                    }
                },
                en: {
                    theme: {
                        light: 'Light',
                        dark: 'Dark'
                    },
                    header: {
                        title: 'Ratio Calculator & Image Crop & Stitch Tool',
                        subtitle: 'Smart dimension calculation, precise cropping and stitching'
                    },
                    imageCrop: {
                        title: '✂️ Image Cropping',
                        uploadText: 'Click to upload, drag and drop, or paste an image here',
                        uploadHint: 'Supports JPG, PNG, GIF and more (can paste multiple)',
                        uploadBtn: 'Select Image',
                        cropBtn: '✂️ Crop Image',
                        rotate90Btn: '🔄 Rotate 90°',
                        resetBtn: '🔄 Reset Crop Area',
                        cancelBtn: '❌ Cancel & Re-upload',
                        originalSize: 'Original Size:',
                        cropArea: 'Crop Area:',
                        currentRatio: 'Crop Ratio:',
                        rotateLabel: 'Rotate Angle:',
                        borderRadiusLabel: 'Corner Radius:',
                        resultTitle: 'Cropped Result Preview',
                        downloadBtn: '💾 Download (PNG)',
                        copyBtn: '📋 Copy Image',
                        copiedBtn: '✅ Copied!',
                        newCropBtn: '🔄 Crop New Image'
                    },
                    stitch: {
                        mode: 'Stitch Mode:',
                        horizontal: 'Horizontal',
                        horizontalHint: '(align by height)',
                        vertical: 'Vertical',
                        verticalHint: '(align by width)',
                        stitchBtn: 'Start Cropping',
                        clearBtn: 'Clear List',
                        placeholder: 'Paste or upload multiple images',
                        previewLabel: 'Stitch Preview',
                        dimensions: 'Total Size: ',
                        preCropBtn: 'Pre-crop Item',
                        savePreCrop: 'Apply & Back',
                        downloadBtn: 'Download Stitched',
                        copyBtn: 'Copy Stitched',
                        backToStitch: '🔙 Back to List',
                        copied: '✅ Copied!',
                        preview: 'images'
                    },
                    config: {
                        title: '⚙️ Persistence',
                        saveBtn: 'Save Settings',
                        clearBtn: 'Clear & Reset All',
                        saveSuccess: 'Configuration saved locally!',
                        clearConfirm: 'Reset all settings and clear images? This cannot be undone.'
                    },
                    ratioSelect: {
                        title: 'Select Ratio',
                        vertical: 'Portrait Photo',
                        horizontal: 'Landscape Photo',
                        square: 'Square',
                        widescreen: 'Widescreen',
                        portrait: 'Portrait Screen',
                        traditional: 'Traditional',
                        verticalTraditional: 'Vertical Traditional',
                        ultrawide: 'Ultrawide',
                        tallImage: 'Tall Image',
                        ratio45: '4:5',
                        miniProgram: 'Mini Program',
                        wechatCover: 'WeChat Cover',
                        custom: 'Custom Ratio',
                        customWidth: 'Width',
                        customHeight: 'Height'
                    },
                    preview: {
                        title: 'Ratio Preview',
                        subtitle: 'Visual display of selected ratio',
                        resultLabel: 'Result'
                    },
                    calculator: {
                        title: 'Dimension Calculator',
                        currentRatio: 'Current Ratio: ',
                        inputWidth: 'Input Width',
                        inputHeight: 'Input Height',
                        calcWidth: 'Calculated Width',
                        calcHeight: 'Calculated Height',
                        widthPlaceholder: 'Enter width value',
                        heightPlaceholder: 'Enter height value',
                        clearBtn: 'Clear All Input'
                    },
                    instructions: {
                        title: 'Instructions:',
                        ratioCalc: '📐 Ratio Calculation:',
                        ratioCalcDesc: 'Select a preset ratio or input a custom ratio, then enter a value in any input field. The system will automatically calculate the other dimension.',
                        imageCrop: '✂️ Image Cropping:',
                        imageCropDesc: 'Click to upload or drag an image to the upload area. After selecting an appropriate ratio, drag the crop box or adjust the corner handles to position the crop area. Click "Crop Image" to complete, then download the result.',
                        supported: 'Supported ratios include common photo and screen ratios. Custom ratios are also supported for calculation and cropping.'
                    },
                    developer: {
                        name: 'ToolBuddy',
                        title: 'Developer',
                        douyin: 'Douyin',
                        wechat: 'WeChat Official',
                        scanQR: 'Scan to Follow',
                        collapse: 'Collapse',
                        expand: 'Expand'
                    }
                }
            };

            // 当前语言
            let currentLang = localStorage.getItem('language') || 'zh';

            // 更新页面文本
            function updateLanguage(lang) {
                currentLang = lang;
                localStorage.setItem('language', lang);

                // 更新所有带有 data-i18n 属性的元素
                document.querySelectorAll('[data-i18n]').forEach(elem => {
                    const keys = elem.getAttribute('data-i18n').split('.');
                    let text = translations[lang];
                    for (const key of keys) {
                        text = text[key];
                    }
                    elem.textContent = text;
                });

                // 更新所有带有 data-i18n-placeholder 属性的元素
                document.querySelectorAll('[data-i18n-placeholder]').forEach(elem => {
                    const keys = elem.getAttribute('data-i18n-placeholder').split('.');
                    let text = translations[lang];
                    for (const key of keys) {
                        text = text[key];
                    }
                    elem.placeholder = text;
                });

                // 更新标题
                document.title = lang === 'zh' ?
                    '比例计算器与图像裁切拼接工具 - 智能尺寸计算与图片裁切拼接' :
                    'Ratio Calculator & Image Crop & Stitch Tool - Smart Calculation, Cropping & Stitching';

                // 更新 meta description
                const metaDesc = document.querySelector('meta[name="description"]');
                if (metaDesc) {
                    metaDesc.content = lang === 'zh' ?
                        '专业的比例计算器和图像裁切工具,支持常用照片比例、屏幕比例等,自定义比例计算更方便,在线裁切图片' :
                        'Professional ratio calculator and image crop tool. Supports common photo and screen ratios, custom ratio calculation, and online image cropping.';
                }
            }

            // 语言切换按钮
            const langButtons = document.querySelectorAll('.lang-btn');
            langButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const lang = btn.dataset.lang;

                    // 更新按钮状态
                    langButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // 更新语言
                    updateLanguage(lang);
                });
            });

            // 页面加载时应用保存的语言
            if (currentLang === 'en') {
                langButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.lang === 'en');
                });
                updateLanguage('en');
            }

            // ========== 全局变量与 DOM 元素 ==========
            let currentRatio = { width: 3, height: 4 };
            let uploadedImage = null;
            let stitchImages = [];
            let draggedItem = null;
            let selectedImageIndex = -1;
            let preCropIndex = -1;
            let isFromStitch = false; // 追踪当前裁切图片是否来自拼接

            // 新增裁切高级状态
            let currentRotation = 0;
            let currentZoom = 1;
            let canvasScale = 1; // 底图显示比例
            let maxZoom = 1;
            const MIN_ZOOM = 0.1;

            // 手势追踪变量
            let isGestureActive = false;
            let initialAngle = 0;
            let initialRotation = 0;
            let initialDist = 0;
            let initialZoom = 1;

            // DOM 元素 - 核心
            const ratioButtons = document.querySelectorAll('.ratio-btn');
            const customWidthInput = document.getElementById('customWidth');
            const customHeightInput = document.getElementById('customHeight');
            const inputWidth = document.getElementById('inputWidth');
            const inputHeight = document.getElementById('inputHeight');
            const calcHeight = document.getElementById('calcHeight');
            const calcWidth = document.getElementById('calcWidth');
            const clearBtn = document.getElementById('clearBtn');
            const previewBox = document.getElementById('previewBox');
            const previewRatio = document.getElementById('previewRatio');
            const previewDesc = document.getElementById('previewDesc');
            const currentRatioText = document.getElementById('currentRatioText');
            const resultDisplay = document.getElementById('resultDisplay');
            const resultValue = document.getElementById('resultValue');
            const themeButtons = document.querySelectorAll('.theme-btn');

            // DOM 元素 - 裁切
            const imageInput = document.getElementById('imageInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const uploadArea = document.getElementById('uploadArea');
            const cropContainer = document.getElementById('cropContainer');
            const cropCanvas = document.getElementById('cropCanvas');
            const cropCtx = cropCanvas.getContext('2d');
            const cropBox = document.getElementById('cropBox');
            const cropOverlay = document.getElementById('cropOverlay');
            const cropBtn = document.getElementById('cropBtn');
            const resetCropBtn = document.getElementById('resetCropBtn');
            const cancelCropBtn = document.getElementById('cancelCropBtn');
            const originalSizeElem = document.getElementById('originalSize');
            const cropSizeElem = document.getElementById('cropSize');
            const cropRatioElem = document.getElementById('cropRatio');
            const cropResult = document.getElementById('cropResult');
            const resultCanvas = document.getElementById('resultCanvas');
            const downloadBtn = document.getElementById('downloadBtn');
            const copyBtn = document.getElementById('copyBtn');
            const newCropBtn = document.getElementById('newCropBtn');
            const cropHandles = document.querySelectorAll('.crop-handle');

            // DOM 元素 - 拼接
            const stitchContainer = document.getElementById('stitchContainer');
            const stitchImageList = document.getElementById('stitchImageList');
            const stitchPreviewInfo = document.getElementById('stitchPreviewInfo');
            const stitchPreviewCanvas = document.getElementById('stitchPreviewCanvas');
            const stitchBtn = document.getElementById('stitchBtn');
            const clearStitchBtn = document.getElementById('clearStitchBtn');
            const stitchModeInputs = document.querySelectorAll('input[name="stitchMode"]');
            const uploadPlaceholderSmall = document.getElementById('uploadPlaceholderSmall');
            const uploadBtnSmall = document.getElementById('uploadBtnSmall');
            const preCropBtn = document.getElementById('preCropBtn');
            const applyPreCropBtn = document.getElementById('applyPreCropBtn');
            const savePreCropBtn = document.getElementById('savePreCropBtn');
            const downloadStitchBtn = document.getElementById('downloadStitchBtn');
            const copyStitchBtn = document.getElementById('copyStitchBtn');
            const cancelStitchBtn = document.getElementById('cancelStitchBtn');
            const saveConfigBtn = document.getElementById('saveConfigBtn');
            const clearConfigBtn = document.getElementById('clearConfigBtn');

            // 裁切控制 DOM
            const rotateBtn = document.getElementById('rotateBtn');
            const rotationSlider = document.getElementById('rotationSlider');
            const rotationInput = document.getElementById('rotationInput');
            const borderRadiusSlider = document.getElementById('borderRadiusSlider');
            const borderRadiusInput = document.getElementById('borderRadiusInput');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const zoomInput = document.getElementById('zoomInput');
            const cornerRadiusHandles = document.querySelectorAll('.corner-radius-handle');
            // const cropOverlay = document.getElementById('cropOverlay'); // Already defined
            const toast = document.getElementById('toast');

            // --- 绑定裁切控制事件 ---
            rotateBtn.addEventListener('click', () => {
                let r = currentRotation + 90;
                if (r > 180) r -= 360;
                currentRotation = r;
                rotationSlider.value = r;
                rotationInput.value = r;
                updateMaxZoom();
                drawCanvas();
            });

            rotationSlider.addEventListener('input', (e) => {
                currentRotation = parseInt(e.target.value);
                rotationInput.value = currentRotation;
                drawCanvas();
            });

            // 双击复位旋转角度
            rotationSlider.addEventListener('dblclick', () => {
                currentRotation = 0;
                rotationSlider.value = 0;
                rotationInput.value = 0;
                drawCanvas();
                showToast(currentLang === 'zh' ? '🔄 旋转角度已复位' : '🔄 Rotation reset');
            });

            rotationInput.addEventListener('input', (e) => {
                currentRotation = parseInt(e.target.value) || 0;
                rotationSlider.value = currentRotation;
                drawCanvas();
            });

            borderRadiusSlider.addEventListener('input', (e) => {
                const r = e.target.value;
                borderRadiusInput.value = r;
                cropBox.style.borderRadius = r + 'px';
            });

            // 双击复位圆角
            borderRadiusSlider.addEventListener('dblclick', () => {
                borderRadiusSlider.value = 0;
                borderRadiusInput.value = 0;
                cropBox.style.borderRadius = '0px';
                showToast(currentLang === 'zh' ? '📐 圆角已复位' : '📐 Corner radius reset');
            });

            borderRadiusInput.addEventListener('input', (e) => {
                const r = e.target.value || 0;
                borderRadiusSlider.value = r;
                cropBox.style.borderRadius = r + 'px';
            });

            zoomInBtn.addEventListener('click', () => {
                currentZoom = Math.min(maxZoom, currentZoom + 0.1);
                updateZoomUI();
            });
            zoomOutBtn.addEventListener('click', () => {
                currentZoom = Math.max(MIN_ZOOM, currentZoom - 0.1);
                updateZoomUI();
            });
            zoomInput.addEventListener('change', (e) => {
                let val = parseInt(e.target.value) / 100;
                currentZoom = Math.max(MIN_ZOOM, Math.min(maxZoom, val));
                updateZoomUI();
            });

            // 圆角控制点拖动
            let isDraggingRadius = false;
            let activeRadiusHandle = null;
            let radiusDragStart = { x: 0, y: 0 };
            let initialRadiusArr = 0;

            cornerRadiusHandles.forEach(handle => {
                const startDrag = (e) => {
                    isDraggingRadius = true;
                    activeRadiusHandle = handle;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    radiusDragStart = { x: clientX, y: clientY };
                    initialRadiusArr = parseInt(borderRadiusSlider.value);
                    e.stopPropagation();
                    e.preventDefault();
                };
                handle.addEventListener('mousedown', startDrag);
                handle.addEventListener('touchstart', startDrag, { passive: false });
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDraggingRadius) return;
                handleRadiusMove(e.clientX, e.clientY);
            });

            document.addEventListener('touchmove', (e) => {
                if (!isDraggingRadius) return;
                handleRadiusMove(e.touches[0].clientX, e.touches[0].clientY);
                e.preventDefault();
            }, { passive: false });

            function handleRadiusMove(clientX, clientY) {
                const edge = activeRadiusHandle.dataset.edge;
                const dx = clientX - radiusDragStart.x;
                const dy = clientY - radiusDragStart.y;
                let delta = 0;
                if (edge === 'top') delta = dy;
                else if (edge === 'right') delta = -dx;
                else if (edge === 'bottom') delta = -dy;
                else if (edge === 'left') delta = dx;

                let nr = Math.max(0, Math.min(250, initialRadiusArr + delta));
                nr = Math.round(nr);
                borderRadiusSlider.value = nr;
                borderRadiusInput.value = nr;
                cropBox.style.borderRadius = nr + 'px';
            }

            // 触控手势支持
            const handleGestureStart = (e) => {
                if (e.touches && e.touches.length === 2) {
                    isGestureActive = true;
                    isDragging = false;
                    isResizing = false;
                    const p1 = e.touches[0], p2 = e.touches[1];
                    initialAngle = Math.atan2(p2.clientY - p1.clientY, p2.clientX - p1.clientX) * 180 / Math.PI;
                    initialRotation = currentRotation;
                    initialDist = Math.hypot(p2.clientX - p1.clientX, p2.clientY - p1.clientY);
                    initialZoom = currentZoom;
                    e.preventDefault();
                }
            };

            const handleGestureMove = (e) => {
                if (e.touches && e.touches.length === 2 && isGestureActive) {
                    const p1 = e.touches[0], p2 = e.touches[1];
                    const curAngle = Math.atan2(p2.clientY - p1.clientY, p2.clientX - p1.clientX) * 180 / Math.PI;
                    let angleDiff = curAngle - initialAngle;

                    // 处理角度突变
                    if (angleDiff > 180) angleDiff -= 360;
                    if (angleDiff < -180) angleDiff += 360;

                    currentRotation = initialRotation + angleDiff;
                    rotationSlider.value = Math.round(currentRotation);
                    rotationInput.value = Math.round(currentRotation);

                    const curDist = Math.hypot(p2.clientX - p1.clientX, p2.clientY - p1.clientY);
                    if (initialDist > 0) {
                        // 增加阻尼系数，降低灵敏度 (0.6)
                        const rawScale = curDist / initialDist;
                        const dampedScale = 1 + (rawScale - 1) * 0.6;
                        currentZoom = Math.max(MIN_ZOOM, Math.min(maxZoom, initialZoom * dampedScale));
                        updateZoomUI();
                    }
                    drawCanvas();
                    e.preventDefault();
                }
            };

            cropOverlay.addEventListener('touchstart', handleGestureStart, { passive: false });
            cropOverlay.addEventListener('touchmove', handleGestureMove, { passive: false });
            cropBox.addEventListener('touchstart', handleGestureStart, { passive: false });
            cropBox.addEventListener('touchmove', handleGestureMove, { passive: false });

            // Mac Trackpad / Wheel Support
            const handleWheel = (e) => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    // 动态阻尼算法：基于 deltaY 的微量计算
                    const zoomSensitivity = 0.005; // 极低灵敏度
                    // 限制变化幅度，防止甚至在极快滑动时失控
                    const delta = Math.max(-0.2, Math.min(0.2, e.deltaY * zoomSensitivity));

                    // 使用 1 - delta 来平滑过渡
                    currentZoom = Math.max(MIN_ZOOM, Math.min(maxZoom, currentZoom * (1 - delta)));
                    updateZoomUI();
                }
            };
            cropOverlay.addEventListener('wheel', handleWheel, { passive: false });
            cropBox.addEventListener('wheel', handleWheel, { passive: false });

            const handleMacGestureStart = (e) => {
                isGestureActive = true;
                initialRotation = currentRotation;
                initialZoom = currentZoom;
                if (e.cancelable) e.preventDefault();
            };
            const handleMacGestureChange = (e) => {
                if (!isGestureActive) return;
                currentRotation = initialRotation + e.rotation;
                rotationSlider.value = Math.round(currentRotation);
                rotationInput.value = Math.round(currentRotation);

                // 深度阻尼 (0.3)，适合高灵敏度触控板
                const dampedScale = 1 + (e.scale - 1) * 0.3;
                currentZoom = Math.max(MIN_ZOOM, Math.min(maxZoom, initialZoom * dampedScale));

                updateZoomUI();
                drawCanvas();
                if (e.cancelable) e.preventDefault();
            };
            const handleMacGestureEnd = () => {
                isGestureActive = false;
            };

            cropOverlay.addEventListener('gesturestart', handleMacGestureStart);
            cropOverlay.addEventListener('gesturechange', handleMacGestureChange);
            cropOverlay.addEventListener('gestureend', handleMacGestureEnd);
            cropBox.addEventListener('gesturestart', handleMacGestureStart);
            cropBox.addEventListener('gesturechange', handleMacGestureChange);
            cropBox.addEventListener('gestureend', handleMacGestureEnd);

            // --- 控制逻辑结束 ---

            // 主题切换
            themeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;

                    // 更新按钮状态
                    themeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // 应用主题
                    if (theme === 'dark') {
                        document.body.classList.add('dark-theme');
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark-theme');
                        localStorage.setItem('theme', 'light');
                    }
                });
            });

            // 加载保存的主题
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.theme === 'dark');
                });
            }

            // 更新比例
            function updateRatio(width, height) {
                currentRatio = { width, height };
                currentRatioText.textContent = `${width}:${height}`;
                previewRatio.textContent = `${width}:${height}`;
                previewDesc.textContent = `${width} × ${height}`;

                updatePreviewBox();
                recalculate();
            }

            // 更新预览框尺寸
            function updatePreviewBox() {
                const maxWidth = 280;
                const maxHeight = 240;
                const ratio = currentRatio.width / currentRatio.height;

                let width, height;

                if (ratio > maxWidth / maxHeight) {
                    width = maxWidth;
                    height = maxWidth / ratio;
                } else {
                    height = maxHeight;
                    width = maxHeight * ratio;
                }

                previewBox.style.width = `${width}px`;
                previewBox.style.height = `${height}px`;
            }

            // 预设比例按钮
            ratioButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    ratioButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    customWidthInput.value = '';
                    customHeightInput.value = '';

                    const ratioStr = btn.dataset.ratio;
                    const [width, height] = ratioStr.split(':').map(Number);
                    updateRatio(width, height);
                });
            });

            // 自定义比例
            function handleCustomRatio() {
                const width = parseFloat(customWidthInput.value);
                const height = parseFloat(customHeightInput.value);

                if (width > 0 && height > 0) {
                    ratioButtons.forEach(b => b.classList.remove('active'));
                    updateRatio(width, height);
                }
            }

            customWidthInput.addEventListener('input', handleCustomRatio);
            customHeightInput.addEventListener('input', handleCustomRatio);

            // 输入宽度，计算高度
            inputWidth.addEventListener('input', () => {
                const width = parseFloat(inputWidth.value);
                if (width > 0) {
                    const height = (width / currentRatio.width) * currentRatio.height;
                    calcHeight.value = height.toFixed(2);
                    inputHeight.value = '';
                    calcWidth.value = '';
                    showResult(`${width} × ${height.toFixed(2)}`);
                } else {
                    calcHeight.value = '';
                    hideResult();
                }
            });

            // 输入高度，计算宽度
            inputHeight.addEventListener('input', () => {
                const height = parseFloat(inputHeight.value);
                if (height > 0) {
                    const width = (height / currentRatio.height) * currentRatio.width;
                    calcWidth.value = width.toFixed(2);
                    inputWidth.value = '';
                    calcHeight.value = '';
                    showResult(`${width.toFixed(2)} × ${height}`);
                } else {
                    calcWidth.value = '';
                    hideResult();
                }
            });

            // 重新计算
            function recalculate() {
                if (inputWidth.value) {
                    const width = parseFloat(inputWidth.value);
                    const height = (width / currentRatio.width) * currentRatio.height;
                    calcHeight.value = height.toFixed(2);
                    showResult(`${width} × ${height.toFixed(2)}`);
                } else if (inputHeight.value) {
                    const height = parseFloat(inputHeight.value);
                    const width = (height / currentRatio.height) * currentRatio.width;
                    calcWidth.value = width.toFixed(2);
                    showResult(`${width.toFixed(2)} × ${height}`);
                }
            }

            // 显示结果
            function showResult(value) {
                resultValue.textContent = value;
                resultDisplay.style.display = 'block';
            }

            // 隐藏结果
            function hideResult() {
                resultDisplay.style.display = 'none';
            }

            // 清空按钮
            clearBtn.addEventListener('click', () => {
                inputWidth.value = '';
                inputHeight.value = '';
                calcHeight.value = '';
                calcWidth.value = '';
                hideResult();
            });

            // 初始化
            updatePreviewBox();

            // ========== 图像裁切与监听器 ==========
            let cropData = {
                x: 50,
                y: 50,
                width: 300,
                height: 400
            };
            let isDragging = false;
            let isResizing = false;
            let dragStart = { x: 0, y: 0 };
            let currentHandle = null;
            // let canvasScale = 1; // Already defined

            // 上传按钮点击
            uploadBtn.addEventListener('click', () => {
                imageInput.click();
            });

            // 小上传按钮点击
            uploadBtnSmall.addEventListener('click', () => {
                imageInput.click();
            });

            // 小上传区域点击
            uploadPlaceholderSmall.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    imageInput.click();
                }
            });

            // 上传区域点击
            uploadPlaceholder.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON') {
                    imageInput.click();
                }
            });

            // 拖拽上传
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadPlaceholder.style.borderColor = 'var(--border-glow)';
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadPlaceholder.style.borderColor = 'var(--border-color)';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation(); // 防止冒泡到 document
                uploadPlaceholder.style.borderColor = 'var(--border-color)';
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                if (files.length === 0) return;

                // 如果拖拽了图片，总是添加到拼接列表
                files.forEach(file => addImageToStitch(file));
            });

            // 小上传框拖拽上传
            uploadPlaceholderSmall.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadPlaceholderSmall.style.borderColor = 'var(--border-glow)';
            });

            uploadPlaceholderSmall.addEventListener('dragleave', () => {
                e.preventDefault();
                e.stopPropagation();
                uploadPlaceholderSmall.style.borderColor = 'var(--border-color)';
            });

            uploadPlaceholderSmall.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadPlaceholderSmall.style.borderColor = 'var(--border-color)';
                const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                if (files.length === 0) return;

                files.forEach(file => addImageToStitch(file));
            });

            // 防止拖拽图片到页面其他地方打开新页面
            document.addEventListener('dragover', (e) => {
                const hasImageFiles = Array.from(e.dataTransfer?.files || []).some(f => f.type.startsWith('image/'));
                if (hasImageFiles) {
                    e.preventDefault();
                }
            });

            document.addEventListener('drop', (e) => {
                // 如果已经在特定区域处理了，就不再处理
                if (e.defaultPrevented) return;

                const hasImageFiles = Array.from(e.dataTransfer?.files || []).some(f => f.type.startsWith('image/'));
                if (hasImageFiles) {
                    e.preventDefault();
                    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                    files.forEach(file => addImageToStitch(file));
                }
            });

            // 文件选择 - 支持多选
            imageInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files).filter(f => f.type.startsWith('image/'));
                if (files.length === 0) return;

                // 如果选择了图片，总是添加到拼接列表
                files.forEach(file => addImageToStitch(file));
                imageInput.value = '';
            });

            // 剪切板粘贴图片 - 支持多张图片
            document.addEventListener('paste', (e) => {
                const items = e.clipboardData?.items;
                if (!items) return;

                const imageFiles = [];
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.type.indexOf('image') !== -1) {
                        const file = item.getAsFile();
                        if (file) {
                            imageFiles.push(file);
                        }
                    }
                }

                if (imageFiles.length === 0) return;

                e.preventDefault();

                // 如果粘贴了图片，总是添加到拼接列表
                imageFiles.forEach(file => addImageToStitch(file));
            });

            // ========== 图片拼接功能逻辑 ==========

            function showStitchUI() {
                uploadPlaceholder.style.display = 'none';
                cropContainer.style.display = 'none';
                cropResult.style.display = 'none';
                stitchContainer.style.display = 'block';
                renderStitchImageList();
                updateStitchPreview();
            }

            function hideStitchUI() {
                stitchContainer.style.display = 'none';
                uploadPlaceholder.style.display = 'block';
                selectedImageIndex = -1;
            }

            function addImageToStitch(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        stitchImages.push({
                            file: file,
                            src: e.target.result,
                            width: img.width,
                            height: img.height
                        });
                        showStitchUI();
                        renderStitchImageList();
                        updateStitchPreview();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            function renderStitchImageList() {
                if (stitchImages.length === 0) {
                    stitchImageList.innerHTML = `
                    <div class="stitch-placeholder">
                        <div class="stitch-placeholder-icon">📋</div>
                        <div data-i18n="stitch.placeholder">粘贴或上传多张图片</div>
                    </div>
                `;
                    updateLanguage(currentLang);
                    return;
                }

                const mode = document.querySelector('input[name="stitchMode"]:checked').value;
                let html = '';

                stitchImages.forEach((imgData, index) => {
                    const arrow = index < stitchImages.length - 1 ?
                        `<div class="stitch-arrow">${mode === 'horizontal' ? '⬌' : '⬍'}</div>` : '';
                    const isSelected = selectedImageIndex === index;

                    html += `
                    <div class="stitch-image-item ${isSelected ? 'selected' : ''}" draggable="true" data-index="${index}" onclick="selectStitchImage(${index})">
                        <div class="stitch-image-order">${index + 1}</div>
                        <img src="${imgData.src}" class="stitch-image-thumb" alt="Image ${index + 1}">
                        <div class="stitch-image-info">${imgData.width} × ${imgData.height}</div>
                        <button class="stitch-image-remove" onclick="event.stopPropagation(); removeStitchImage(${index})">×</button>
                        ${arrow}
                    </div>
                `;
                });

                stitchImageList.innerHTML = html;

                document.querySelectorAll('.stitch-image-item').forEach(item => {
                    item.addEventListener('dragstart', handleDragStart);
                    item.addEventListener('dragover', handleDragOver);
                    item.addEventListener('drop', handleDrop);
                    item.addEventListener('dragend', handleDragEnd);
                });
            }

            function selectStitchImage(index) {
                if (selectedImageIndex === index) {
                    selectedImageIndex = -1;
                } else {
                    selectedImageIndex = index;
                }
                renderStitchImageList();
                updateStitchPreview();
            }

            function handleDragStart(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }

            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }

            function handleDrop(e) {
                e.preventDefault();
                if (draggedItem !== this) {
                    const fromIndex = parseInt(draggedItem.dataset.index);
                    const toIndex = parseInt(this.dataset.index);

                    const [removed] = stitchImages.splice(fromIndex, 1);
                    stitchImages.splice(toIndex, 0, removed);

                    renderStitchImageList();
                    updateStitchPreview();
                }
            }

            function handleDragEnd() {
                this.classList.remove('dragging');
                draggedItem = null;
            }

            function removeStitchImage(index) {
                stitchImages.splice(index, 1);
                if (selectedImageIndex === index) {
                    selectedImageIndex = -1;
                } else if (selectedImageIndex > index) {
                    selectedImageIndex--;
                }
                if (stitchImages.length === 0) {
                    hideStitchUI();
                } else {
                    renderStitchImageList();
                    updateStitchPreview();
                }
            }

            function clearStitchImages() {
                stitchImages = [];
                selectedImageIndex = -1;
                hideStitchUI();
                imageInput.value = '';
            }

            function updateStitchPreview() {
                const ctx = stitchPreviewCanvas.getContext('2d');

                if (stitchImages.length === 0) {
                    stitchPreviewCanvas.width = 0;
                    stitchPreviewCanvas.height = 0;
                    stitchPreviewInfo.innerHTML = '';
                    return;
                }

                const mode = document.querySelector('input[name="stitchMode"]:checked').value;

                if (selectedImageIndex >= 0 && selectedImageIndex < stitchImages.length) {
                    const imgData = stitchImages[selectedImageIndex];
                    stitchPreviewCanvas.width = imgData.width;
                    stitchPreviewCanvas.height = imgData.height;
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, stitchPreviewCanvas.width, stitchPreviewCanvas.height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = imgData.src;
                    stitchPreviewInfo.innerHTML = `
                    <div class="stitch-preview-text">
                        ${currentLang === 'zh' ? '单张预览' : 'Single Image Preview'}: ${imgData.width} × ${imgData.height}
                    </div>
                `;
                    // 显示预裁切按钮
                    preCropBtn.style.display = 'flex';
                    // 隐藏普通拼接按钮（如果要先预裁切）
                    stitchBtn.style.display = 'none';
                    downloadStitchBtn.style.display = 'none'; // 隐藏下载拼接图按钮
                    copyStitchBtn.style.display = 'none'; // 隐藏复制拼接图按钮
                    return;
                } else {
                    preCropBtn.style.display = 'none';
                    stitchBtn.style.display = 'flex';
                    if (stitchImages.length >= 2) {
                        downloadStitchBtn.style.display = 'flex';
                        copyStitchBtn.style.display = 'flex';
                    } else {
                        downloadStitchBtn.style.display = 'none';
                        copyStitchBtn.style.display = 'none';
                    }
                }

                if (stitchImages.length === 1) {
                    const imgData = stitchImages[0];
                    stitchPreviewCanvas.width = imgData.width;
                    stitchPreviewCanvas.height = imgData.height;
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, stitchPreviewCanvas.width, stitchPreviewCanvas.height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = imgData.src;
                    stitchPreviewInfo.innerHTML = `
                    <div class="stitch-preview-text">
                        ${currentLang === 'zh' ? '已添加1张图片，点击“开始裁切”或继续添加' : '1 image added. Click "Start Crop" or add more.'}
                    </div>
                `;
                    // 更新按钮文本
                    const stitchBtnText = stitchBtn.querySelector('span:last-child');
                    if (stitchBtnText) {
                        stitchBtnText.textContent = translations[currentLang].imageCrop.cropBtn.replace('✂️ ', '');
                        stitchBtn.querySelector('span:first-child').textContent = '✂️ ';
                    }
                    downloadStitchBtn.style.display = 'none'; // 单张图片不显示下载拼接图按钮
                    copyStitchBtn.style.display = 'none';
                    return;
                } else {
                    // 恢复拼接按钮文本
                    const stitchBtnText = stitchBtn.querySelector('span:last-child');
                    if (stitchBtnText) {
                        stitchBtnText.textContent = translations[currentLang].stitch.stitchBtn.replace('🔗 ', '');
                        stitchBtn.querySelector('span:first-child').textContent = '🔗 ';
                    }
                    // 仅在非选中单图状态下显示
                    if (selectedImageIndex === -1) {
                        downloadStitchBtn.style.display = 'flex';
                        copyStitchBtn.style.display = 'flex';
                    }
                }

                let totalWidth = 0, totalHeight = 0;

                if (mode === 'horizontal') {
                    const maxHeight = Math.max(...stitchImages.map(img => img.height));
                    totalHeight = maxHeight;
                    stitchImages.forEach(img => {
                        const scale = maxHeight / img.height;
                        totalWidth += img.width * scale;
                    });
                } else {
                    const maxWidth = Math.max(...stitchImages.map(img => img.width));
                    totalWidth = maxWidth;
                    stitchImages.forEach(img => {
                        const scale = maxWidth / img.width;
                        totalHeight += img.height * scale;
                    });
                }

                stitchPreviewCanvas.width = totalWidth;
                stitchPreviewCanvas.height = totalHeight;

                const i18n = translations[currentLang];
                stitchPreviewInfo.innerHTML = `
                <div class="stitch-preview-text">
                    ${i18n.stitch.dimensions}<span>${Math.round(totalWidth)} × ${Math.round(totalHeight)}</span>
                    (${stitchImages.length} ${i18n.stitch.preview})
                </div>
            `;

                Promise.all(stitchImages.map(imgData => loadImageFromSrc(imgData.src))).then(images => {
                    ctx.clearRect(0, 0, totalWidth, totalHeight);

                    if (mode === 'horizontal') {
                        const maxHeight = Math.max(...stitchImages.map(img => img.height));
                        let x = 0;
                        images.forEach((img, index) => {
                            const scale = maxHeight / stitchImages[index].height;
                            const scaledWidth = stitchImages[index].width * scale;
                            ctx.drawImage(img, x, 0, scaledWidth, maxHeight);
                            x += scaledWidth;
                        });
                    } else {
                        const maxWidth = Math.max(...stitchImages.map(img => img.width));
                        let y = 0;
                        images.forEach((img, index) => {
                            const scale = maxWidth / stitchImages[index].width;
                            const scaledHeight = stitchImages[index].height * scale;
                            ctx.drawImage(img, 0, y, maxWidth, scaledHeight);
                            y += scaledHeight;
                        });
                    }
                });
            }

            async function performStitch() {
                if (stitchImages.length === 0) return;

                if (stitchImages.length === 1) {
                    const img = await loadImageFromSrc(stitchImages[0].src);
                    uploadedImage = img;
                    isFromStitch = false;
                    cancelStitchBtn.style.display = 'none';
                    stitchImages = [];
                    hideStitchUI();
                    initCropArea();
                    uploadPlaceholder.style.display = 'none';
                    cropContainer.style.display = 'block';
                    return;
                }

                isFromStitch = true;
                cancelStitchBtn.style.display = 'flex';


                const mode = document.querySelector('input[name="stitchMode"]:checked').value;

                if (mode === 'horizontal') {
                    const maxHeight = Math.max(...stitchImages.map(img => img.height));
                    const totalWidth = stitchImages.reduce((sum, img) => {
                        const scale = maxHeight / img.height;
                        return sum + img.width * scale;
                    }, 0);

                    const canvas = document.createElement('canvas');
                    canvas.width = totalWidth;
                    canvas.height = maxHeight;
                    const ctx = canvas.getContext('2d');

                    let x = 0;
                    for (const imgData of stitchImages) {
                        const img = await loadImageFromSrc(imgData.src);
                        const scale = maxHeight / imgData.height;
                        const scaledWidth = imgData.width * scale;
                        ctx.drawImage(img, x, 0, scaledWidth, maxHeight);
                        x += scaledWidth;
                    }

                    const stitchedImg = new Image();
                    stitchedImg.onload = () => {
                        uploadedImage = stitchedImg;
                        // 不再清除 stitchImages，以便撤回
                        // 确保隐藏拼接 UI (虽然之前可能漏了，这里补上更稳健)
                        if (typeof hideStitchUI === 'function') hideStitchUI();
                        else stitchContainer.style.display = 'none';

                        initCropArea();
                        uploadPlaceholder.style.display = 'none';
                        cropContainer.style.display = 'block';
                        cropResult.style.display = 'none';

                        // 自动滚动到裁切框
                        setTimeout(() => {
                            const target = document.getElementById('cropContainer');
                            if (target) {
                                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 100);
                    };
                    stitchedImg.src = canvas.toDataURL('image/png');
                } else {
                    const maxWidth = Math.max(...stitchImages.map(img => img.width));
                    const totalHeight = stitchImages.reduce((sum, img) => {
                        const scale = maxWidth / img.width;
                        return sum + img.height * scale;
                    }, 0);

                    const canvas = document.createElement('canvas');
                    canvas.width = maxWidth;
                    canvas.height = totalHeight;
                    const ctx = canvas.getContext('2d');

                    let y = 0;
                    for (const imgData of stitchImages) {
                        const img = await loadImageFromSrc(imgData.src);
                        const scale = maxWidth / imgData.width;
                        const scaledHeight = imgData.height * scale;
                        ctx.drawImage(img, 0, y, maxWidth, scaledHeight);
                        y += scaledHeight;
                    }

                    const stitchedImg = new Image();
                    stitchedImg.onload = () => {
                        uploadedImage = stitchedImg;
                        // 不再清除 stitchImages，以便撤回
                        hideStitchUI();
                        initCropArea();
                        uploadPlaceholder.style.display = 'none';
                        cropContainer.style.display = 'block';
                        cropResult.style.display = 'none';

                        // 自动滚动到裁切框
                        setTimeout(() => {
                            const target = document.getElementById('cropContainer');
                            if (target) {
                                target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 100);
                    };
                    stitchedImg.src = canvas.toDataURL('image/png');
                }
            }

            function loadImageFromSrc(src) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = src;
                });
            }

            stitchModeInputs.forEach(input => {
                input.addEventListener('change', () => {
                    renderStitchImageList();
                    updateStitchPreview();
                });
            });

            stitchBtn.addEventListener('click', performStitch);
            clearStitchBtn.addEventListener('click', clearStitchImages);

            window.removeStitchImage = removeStitchImage;
            window.selectStitchImage = selectStitchImage;

            // 执行预裁切前的初始化
            async function startPreCrop() {
                if (selectedImageIndex < 0) return;

                preCropIndex = selectedImageIndex;
                const imgData = stitchImages[preCropIndex];

                uploadedImage = await loadImageFromSrc(imgData.src);

                stitchContainer.style.display = 'none';
                cropContainer.style.display = 'block';
                cropResult.style.display = 'none';
                savePreCropBtn.style.display = 'none'; // 还没裁，先隐藏

                initCropArea();

                // 平滑滑动到裁切区域顶部
                setTimeout(() => {
                    const target = document.querySelector('.image-crop-section');
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }


            // 撤回拼接并返回列表
            function cancelStitch() {
                isFromStitch = false;
                cancelStitchBtn.style.display = 'none';
                showStitchUI();

                // 确保列表和预览状态正确
                renderStitchImageList();
                updateStitchPreview();

                // 平滑回滚到预览区
                setTimeout(() => {
                    const target = document.querySelector('.stitch-preview-container');
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }

            preCropBtn.addEventListener('click', startPreCrop);
            cancelStitchBtn.addEventListener('click', () => {
                preCropIndex = -1;
                cancelStitch();
            });

            // 生成拼接画布
            async function createStitchCanvas() {
                if (stitchImages.length < 2) return null;

                const mode = document.querySelector('input[name="stitchMode"]:checked').value;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                if (mode === 'horizontal') {
                    const maxHeight = Math.max(...stitchImages.map(img => img.height));
                    const totalWidth = stitchImages.reduce((sum, img) => {
                        const scale = maxHeight / img.height;
                        return sum + img.width * scale;
                    }, 0);
                    canvas.width = totalWidth;
                    canvas.height = maxHeight;
                    let x = 0;
                    for (const imgData of stitchImages) {
                        const img = await loadImageFromSrc(imgData.src);
                        const scale = maxHeight / imgData.height;
                        const scaledWidth = imgData.width * scale;
                        ctx.drawImage(img, x, 0, scaledWidth, maxHeight);
                        x += scaledWidth;
                    }
                } else {
                    const maxWidth = Math.max(...stitchImages.map(img => img.width));
                    const totalHeight = stitchImages.reduce((sum, img) => {
                        const scale = maxWidth / img.width;
                        return sum + img.height * scale;
                    }, 0);
                    canvas.width = maxWidth;
                    canvas.height = totalHeight;
                    let y = 0;
                    for (const imgData of stitchImages) {
                        const img = await loadImageFromSrc(imgData.src);
                        const scale = maxWidth / imgData.width;
                        const scaledHeight = imgData.height * scale;
                        ctx.drawImage(img, 0, y, maxWidth, scaledHeight);
                        y += scaledHeight;
                    }
                }
                return canvas;
            }

            // 直接下载
            async function downloadStitchResult() {
                const canvas = await createStitchCanvas();
                if (!canvas) return;

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `stitched_image_${new Date().getTime()}.png`;
                    link.href = url;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                }, 'image/png');
            }

            // 通用复制图片到剪贴板函数（兼容 Safari 和 Chrome）
            // 通用复制图片到剪贴板函数（兼容 Safari 和 Chrome）
            async function copyImageToClipboard(imageSource, successCallback, failCallback) {
                try {
                    // 检查剪贴板 API 是否可用
                    if (!navigator.clipboard || typeof ClipboardItem === 'undefined') {
                        throw new Error('Clipboard API not supported');
                    }

                    // 构造一个 Promise，该 Promise 最终会 Resolve 为一个 Blob
                    // 这允许我们在数据准备好之前就调用 clipboard.write，从而满足 Safari 的同步调用要求
                    const blobPromise = new Promise(async (resolve, reject) => {
                        try {
                            let canvas = imageSource;
                            // 如果传入的是 Promise（例如来自 createStitchCanvas()），先等待其解析
                            if (imageSource instanceof Promise) {
                                canvas = await imageSource;
                            }

                            if (!canvas) {
                                reject(new Error('Canvas generation failed'));
                                return;
                            }

                            canvas.toBlob((blob) => {
                                if (blob) resolve(blob);
                                else reject(new Error('Failed to create blob'));
                            }, 'image/png');
                        } catch (err) {
                            reject(err);
                        }
                    });

                    // 关键点：这里必须同步创建 ClipboardItem 并立即调用 write
                    // 将 Blob 的 Promise 传递给 ClipboardItem
                    const item = new ClipboardItem({ 'image/png': blobPromise });
                    await navigator.clipboard.write([item]);

                    if (successCallback) successCallback();
                    return true;
                } catch (err) {
                    console.error('Copy failed:', err);
                    if (failCallback) failCallback(err);
                    return false;
                }
            }

            // 直接复制
            function copyStitchResult() {
                // 1. 同步检查是否有足够的图片（不能使用 await，否则会断开 User Gesture）
                if (!stitchImages || stitchImages.length < 2) {
                    showToast(currentLang === 'zh' ? '⚠️ 至少需要2张图片才能拼接' : '⚠️ Need at least 2 images');
                    return;
                }

                // 2. 立即启动 Canvas 生成任务，拿到 Promise
                const canvasPromise = createStitchCanvas();

                // 3. 获取原始按钮文本用于后续恢复
                const originalText = copyStitchBtn.querySelector('span:last-child').textContent;

                // 4. 将 Promise 传递给复制函数，这样 clipboard.write 可以立即被同步调用
                copyImageToClipboard(
                    canvasPromise,
                    () => {
                        // 成功反馈
                        copyStitchBtn.querySelector('span:last-child').textContent = translations[currentLang].stitch.copied;
                        copyStitchBtn.classList.remove('crop-btn-primary');
                        copyStitchBtn.classList.add('crop-btn-success');
                        showToast(currentLang === 'zh' ? '✅ 已复制到剪贴板' : '✅ Copied to clipboard');

                        setTimeout(() => {
                            copyStitchBtn.querySelector('span:last-child').textContent = originalText;
                            copyStitchBtn.classList.add('crop-btn-primary');
                            copyStitchBtn.classList.remove('crop-btn-success');
                        }, 2000);
                    },
                    (err) => {
                        console.log('Copy error caught:', err); // Debug
                        // 复制失败处理逻辑 Fallback
                        // 虽然我们尽力适配了 Safari，但如果还是失败（比如iOS版本极老），走自动下载
                        const link = document.createElement('a');
                        link.download = `stitch-result-${new Date().getTime()}.png`;

                        // 注意：这里需要再次等待 promise 才能拿到 URL，因为 copy 失败了
                        canvasPromise.then(canvas => {
                            if (canvas) {
                                link.href = canvas.toDataURL('image/png');
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                showToast(currentLang === 'zh' ? '⚠️ 浏览器限制无法直接复制，已自动为您下载' : '⚠️ Copied failed, downloading instead');
                            }
                        }).catch(e => {
                            showToast(currentLang === 'zh' ? '❌ 复制失败，请尝试手动下载' : '❌ Copy failed, please download manually');
                        });
                    }
                );
            }

            downloadStitchBtn.addEventListener('click', downloadStitchResult);
            copyStitchBtn.addEventListener('click', copyStitchResult);

            // ========== 持久化存储 (IndexedDB) ==========
            const DB_NAME = 'ImageCropToolDB';
            const STORE_NAME = 'appConfig';

            function initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, 1);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME);
                        }
                    };
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                });
            }

            async function saveToDB(key, data) {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORE_NAME, 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.put(data, key);
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
            }

            async function getFromDB(key) {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORE_NAME, 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async function clearDB() {
                const db = await initDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORE_NAME, 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    store.clear();
                    transaction.oncomplete = () => resolve();
                });
            }

            // 保存配置
            async function saveConfig() {
                const config = {
                    currentRatio,
                    inputWidth: inputWidth.value,
                    inputHeight: inputHeight.value,
                    calcWidth: calcWidth.value,
                    calcHeight: calcHeight.value,
                    customWidth: customWidthInput.value,
                    customHeight: customHeightInput.value,
                    stitchMode: document.querySelector('input[name="stitchMode"]:checked').value,
                    stitchImages: stitchImages // 包含图片数据
                };

                await saveToDB('userConfig', config);
                alert(translations[currentLang].config.saveSuccess);
            }

            // 加载配置
            async function loadConfig() {
                const config = await getFromDB('userConfig');
                if (!config) return;

                // 恢复属性
                if (config.currentRatio) {
                    currentRatio = config.currentRatio;
                    // 找到对应的比例按钮并激活，或者设置自定义比例
                    let foundRatio = false;
                    ratioButtons.forEach(btn => {
                        const [w, h] = btn.dataset.ratio.split(':').map(Number);
                        if (w === currentRatio.width && h === currentRatio.height) {
                            btn.classList.add('active');
                            foundRatio = true;
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    if (!foundRatio) {
                        customWidthInput.value = currentRatio.width;
                        customHeightInput.value = currentRatio.height;
                    }
                    updateRatio(currentRatio.width, currentRatio.height);
                }

                inputWidth.value = config.inputWidth || '';
                inputHeight.value = config.inputHeight || '';
                calcWidth.value = config.calcWidth || '';
                calcHeight.value = config.calcHeight || '';
                customWidthInput.value = config.customWidth || '';
                customHeightInput.value = config.customHeight || '';

                if (config.stitchMode) {
                    const stitchModeRadio = document.querySelector(`input[name="stitchMode"][value="${config.stitchMode}"]`);
                    if (stitchModeRadio) {
                        stitchModeRadio.checked = true;
                    }
                }

                if (config.stitchImages && config.stitchImages.length > 0) {
                    stitchImages = config.stitchImages;
                    showStitchUI();
                    renderStitchImageList();
                    updateStitchPreview();
                }

                recalculate();
            }

            // 清除配置
            async function clearConfig() {
                if (!confirm(translations[currentLang].config.clearConfirm)) return;

                await clearDB();
                localStorage.removeItem('theme');
                localStorage.removeItem('language'); // 也清除语言设置
                location.reload(); // 刷新以恢复原始状态
            }

            saveConfigBtn.addEventListener('click', saveConfig);
            clearConfigBtn.addEventListener('click', clearConfig);

            // 页面加完毕后加载配置
            window.addEventListener('load', loadConfig);
            // ========== 原有图片加载功能 ==========
            function loadImage(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        uploadedImage = img;
                        isFromStitch = false; // 普通上传，关闭标志
                        cancelStitchBtn.style.display = 'none';

                        // 先显示容器，确保能获取到正确的各种尺寸
                        uploadPlaceholder.style.display = 'none';
                        cropContainer.style.display = 'block';
                        cropResult.style.display = 'none';

                        // 稍微延迟以确保DOM布局更新完成，解决移动端裁切框过大问题
                        setTimeout(() => {
                            initCropArea();
                        }, 10);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            // 初始化裁切区域
            function initCropArea() {
                currentRotation = 0;
                borderRadiusSlider.value = 0;
                borderRadiusInput.value = 0;
                rotationSlider.value = 0;
                rotationInput.value = 0;
                cropBox.style.borderRadius = '0px';

                // 先计算最大缩放限制
                updateMaxZoom();

                // 初始缩放不应超过最大限制 (防止大图加载时初始溢出)
                currentZoom = Math.min(1.0, maxZoom);
                zoomInput.value = Math.round(currentZoom * 100);

                drawCanvas();
                resetCropArea();
                updateZoomUI();

                // 更新信息
                originalSizeElem.textContent = `${uploadedImage.width} × ${uploadedImage.height}`;
                updateCropInfo();
            }

            // 绘制底图（支持旋转与缩放）
            function drawCanvas() {
                const wrapper = document.querySelector('.crop-canvas-wrapper');
                // 获取容器宽度（不含 padding，因为 wrapper 已经处理了负 margin 撑满卡片）
                // 这里直接用 clientWidth 即可，它现在代表满宽
                const maxWidth = wrapper.clientWidth || 800;
                // 彻底移除高度限制，允许长图纵向延伸

                // Calculate rotated bounding box dimensions
                const rad = currentRotation * Math.PI / 180;
                const absCos = Math.abs(Math.cos(rad));
                const absSin = Math.abs(Math.sin(rad));
                const rotatedWidth = uploadedImage.width * absCos + uploadedImage.height * absSin;
                const rotatedHeight = uploadedImage.width * absSin + uploadedImage.height * absCos;

                let displayWidth = rotatedWidth;
                let displayHeight = rotatedHeight;

                // 移除自动 fit 逻辑
                // 图片尺寸完全由 currentZoom 控制
                // 初始状态下，currentZoom 已在 initCropArea 中被设为适合容器宽度的值(maxZoom)


                // Apply zoom
                displayWidth *= currentZoom;
                displayHeight *= currentZoom;

                const oldCanvasScale = canvasScale;
                canvasScale = displayWidth / rotatedWidth; // Scale of the image on the canvas relative to its rotated actual size

                // If scale changes, adjust crop box to maintain relative size and position
                if (oldCanvasScale && oldCanvasScale !== canvasScale && cropData.width) {
                    const scaleRatio = canvasScale / oldCanvasScale;
                    cropData.x *= scaleRatio;
                    cropData.y *= scaleRatio;
                    cropData.width *= scaleRatio;
                    cropData.height *= scaleRatio;

                    // 边界检查：防止放大且裁切框贴边时，因精度或偏移导致溢出
                    // 始终将其限制在当前的显示范围内
                    const maxW = displayWidth;
                    const maxH = displayHeight;

                    // 1. 尺寸不能超过画布
                    if (cropData.width > maxW) cropData.width = maxW;
                    if (cropData.height > maxH) cropData.height = maxH;

                    // 2. 位置不能小于0
                    if (cropData.x < 0) cropData.x = 0;
                    if (cropData.y < 0) cropData.y = 0;

                    // 3. 确保不溢出右下边界
                    if (cropData.x + cropData.width > maxW) {
                        cropData.x = maxW - cropData.width;
                    }
                    if (cropData.y + cropData.height > maxH) {
                        cropData.y = maxH - cropData.height;
                    }

                    updateCropBox();
                }

                cropCanvas.width = displayWidth;
                cropCanvas.height = displayHeight;

                cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
                cropCtx.save();

                // Translate origin to center of canvas
                cropCtx.translate(cropCanvas.width / 2, cropCanvas.height / 2);
                cropCtx.scale(canvasScale, canvasScale);
                cropCtx.rotate(rad);

                // Draw image centered
                cropCtx.drawImage(uploadedImage, -uploadedImage.width / 2, -uploadedImage.height / 2);

                cropCtx.restore();
            }

            // 更新最大缩放限制
            function updateMaxZoom() {
                if (!uploadedImage) return;
                const wrapper = document.querySelector('.crop-canvas-wrapper');

                // 关键修正：直接使用 wrapper 自身的宽度作为最大限制
                // 因为我们在 CSS 中通过 negative margin 让 wrapper 比 parent 更宽（撑满了卡片）
                // 所以必须用 wrapper.clientWidth 才能获取到真正的“满宽”数值
                const currentWidth = wrapper.clientWidth;
                const maxWidth = currentWidth > 0 ? currentWidth : window.innerWidth;

                const rad = currentRotation * Math.PI / 180;
                const absCos = Math.abs(Math.cos(rad));
                const absSin = Math.abs(Math.sin(rad));
                const rotatedWidth = uploadedImage.width * absCos + uploadedImage.height * absSin;

                // 这里的缩放仅受容器当前宽度的物理限制，不再强制限制高度（由滚动或溢出处理）
                // 计算让图片填满容器所需的最大 Zoom 值
                // 限制 Zoom 上限，使得图片宽度永远不会超过容器宽度
                // 这样就防止了“数值增加单图片不变大”的问题
                maxZoom = maxWidth / rotatedWidth;

                // 更新输入框的最大值 (显示为百分比)
                // 允许一定的最小值以防计算异常
                if (maxZoom < 0.01) maxZoom = 0.01;

                if (zoomInput) {
                    zoomInput.max = Math.floor(maxZoom * 100);
                }
            }

            // 重置裁切区域
            function resetCropArea() {
                const ratio = currentRatio.width / currentRatio.height;
                const canvasW = cropCanvas.width;
                const canvasH = cropCanvas.height;

                let width, height;
                if (canvasW / ratio <= canvasH) {
                    width = canvasW;
                    height = width / ratio; // Use width to calculate height based on ratio
                } else {
                    height = canvasH;
                    width = height * ratio; // Use height to calculate width based on ratio
                }

                cropData = {
                    x: (canvasW - width) / 2,
                    y: (canvasH - height) / 2,
                    width: width,
                    height: height
                };
                updateCropBox();
            }

            function updateZoomUI() {
                zoomInput.value = Math.round(currentZoom * 100);
                drawCanvas();
            }

            function getCanvasPoint(clientX, clientY) {
                const overlayRect = cropOverlay.getBoundingClientRect();
                const relX = clientX - overlayRect.left;
                const relY = clientY - overlayRect.top;
                return {
                    x: (relX / overlayRect.width) * cropCanvas.width,
                    y: (relY / overlayRect.height) * cropCanvas.height
                };
            }

            function updateCropBox() {
                // 计算 CSS 视觉尺寸与 Canvas 物理尺寸的比例
                // 当 CSS max-width 生效时，offsetWidth 会小于 width
                const visualScale = (cropCanvas.offsetWidth > 0 && cropCanvas.width > 0)
                    ? cropCanvas.offsetWidth / cropCanvas.width
                    : 1;

                cropBox.style.left = (cropData.x * visualScale) + 'px';
                cropBox.style.top = (cropData.y * visualScale) + 'px';
                cropBox.style.width = (cropData.width * visualScale) + 'px';
                cropBox.style.height = (cropData.height * visualScale) + 'px';
                updateCropInfo();
            }

            function updateCropInfo() {
                const actualWidth = Math.round(cropData.width / canvasScale);
                const actualHeight = Math.round(cropData.height / canvasScale);
                cropSizeElem.textContent = `${actualWidth} × ${actualHeight}`;
                const gcd = getGCD(actualWidth, actualHeight);
                const ratioW = actualWidth / gcd;
                const ratioH = actualHeight / gcd;
                cropRatioElem.textContent = `${ratioW}:${ratioH}`;
            }

            function getGCD(a, b) {
                return b === 0 ? a : getGCD(b, a % b);
            }

            // 事件监听器绑定
            const startDrag = (e) => {
                if (e.target.classList.contains('crop-handle') || e.target.classList.contains('corner-radius-handle')) return;
                isDragging = true;
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const pt = getCanvasPoint(clientX, clientY);
                dragStart = { x: pt.x - cropData.x, y: pt.y - cropData.y };
                if (e.cancelable) e.preventDefault();
            };

            cropBox.addEventListener('mousedown', startDrag);
            cropBox.addEventListener('touchstart', startDrag, { passive: false });

            cropHandles.forEach(handle => {
                const startResize = (e) => {
                    isResizing = true;
                    currentHandle = handle.classList[1];
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    const pt = getCanvasPoint(clientX, clientY);
                    dragStart = {
                        x: pt.x, y: pt.y,
                        cropX: cropData.x, cropY: cropData.y,
                        cropW: cropData.width, cropH: cropData.height
                    };
                    if (e.cancelable) e.preventDefault();
                    e.stopPropagation();
                };
                handle.addEventListener('mousedown', startResize);
                handle.addEventListener('touchstart', startResize, { passive: false });
            });

            document.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY));
            document.addEventListener('touchmove', (e) => {
                if (isDragging || isResizing) {
                    handleMove(e.touches[0].clientX, e.touches[0].clientY);
                    if (e.cancelable) e.preventDefault();
                }
            }, { passive: false });

            function handleMove(clientX, clientY) {
                const pt = getCanvasPoint(clientX, clientY);
                if (isDragging) {
                    cropData.x = Math.max(0, Math.min(pt.x - dragStart.x, cropCanvas.width - cropData.width));
                    cropData.y = Math.max(0, Math.min(pt.y - dragStart.y, cropCanvas.height - cropData.height));
                    updateCropBox();
                } else if (isResizing && currentHandle) {
                    const dx = pt.x - dragStart.x;
                    const dy = pt.y - dragStart.y;
                    const ratio = currentRatio.width / currentRatio.height;

                    let newX = dragStart.cropX;
                    let newY = dragStart.cropY;
                    let newW = dragStart.cropW;
                    let newH = dragStart.cropH;

                    if (currentHandle === 'crop-handle-se') {
                        newW = Math.max(50, dragStart.cropW + dx);
                        newH = newW / ratio;
                        if (newX + newW > cropCanvas.width) { newW = cropCanvas.width - newX; newH = newW / ratio; }
                        if (newY + newH > cropCanvas.height) { newH = cropCanvas.height - newY; newW = newH * ratio; }
                    } else if (currentHandle === 'crop-handle-sw') {
                        newW = Math.max(50, dragStart.cropW - dx);
                        newH = newW / ratio;
                        if (newX + (dragStart.cropW - newW) < 0) { newW = newX + dragStart.cropW; newH = newW / ratio; }
                        if (newY + newH > cropCanvas.height) { newH = cropCanvas.height - newY; newW = newH * ratio; }
                        newX = dragStart.cropW + dragStart.cropX - newW;
                    } else if (currentHandle === 'crop-handle-ne') {
                        newH = Math.max(50, dragStart.cropH - dy);
                        newW = newH * ratio;
                        if (newY + (dragStart.cropH - newH) < 0) { newH = newY + dragStart.cropH; newW = newH * ratio; }
                        if (newX + newW > cropCanvas.width) { newW = cropCanvas.width - newX; newH = newW / ratio; }
                        newY = dragStart.cropH + dragStart.cropY - newH;
                    } else if (currentHandle === 'crop-handle-nw') {
                        newW = Math.max(50, dragStart.cropW - dx);
                        newH = newW / ratio;
                        if (newX + (dragStart.cropW - newW) < 0) { newW = newX + dragStart.cropW; newH = newW / ratio; }
                        if (newY + (dragStart.cropH - newH) < 0) { newH = newY + dragStart.cropH; newW = newH * ratio; }
                        newX = dragStart.cropW + dragStart.cropX - newW;
                        newY = dragStart.cropH + dragStart.cropY - newH;
                    }

                    cropData.x = newX;
                    cropData.y = newY;
                    cropData.width = newW;
                    cropData.height = newH;
                    updateCropBox();
                }
            }


            function clearAllStates() {
                isDragging = false;
                isResizing = false;
                isDraggingRadius = false;
                currentHandle = null;
                isGestureActive = false;
                activeRadiusHandle = null;
            }
            document.addEventListener('mouseup', clearAllStates);
            document.addEventListener('touchend', clearAllStates);

            resetCropBtn.addEventListener('click', () => {
                currentRotation = 0;
                currentZoom = 1;
                borderRadiusSlider.value = 0;
                borderRadiusInput.value = 0;
                rotationSlider.value = 0;
                rotationInput.value = 0;
                cropBox.style.borderRadius = '0px';
                updateMaxZoom();
                drawCanvas();
                resetCropArea();
                updateZoomUI();
            });

            cancelCropBtn.addEventListener('click', () => {
                preCropIndex = -1;
                uploadedImage = null;
                cropContainer.style.display = 'none';
                uploadPlaceholder.style.display = 'block';
                cropResult.style.display = 'none';
                imageInput.value = '';
            });

            function showToast(message) {
                let toastEl = document.getElementById('toast');
                if (!toastEl) {
                    toastEl = document.createElement('div');
                    toastEl.id = 'toast';
                    toastEl.className = 'toast-message';
                    document.body.appendChild(toastEl);
                }
                toastEl.textContent = message;
                toastEl.classList.add('show');
                setTimeout(() => toastEl.classList.remove('show'), 2000);
            }

            cropBtn.addEventListener('click', performCrop);
            applyPreCropBtn.addEventListener('click', performCrop); // 裁切前的应用按钮，直接执行裁切


            savePreCropBtn.addEventListener('click', () => {
                const dataUrl = resultCanvas.toDataURL('image/png');
                const updateItem = (targetIndex) => {
                    stitchImages[targetIndex].src = dataUrl;
                    const img = new Image();
                    img.onload = () => {
                        stitchImages[targetIndex].width = img.width;
                        stitchImages[targetIndex].height = img.height;
                        finishSaving();
                    };
                    img.src = dataUrl;
                };

                const finishSaving = () => {
                    // 先重置选中状态，确保 updateStitchPreview 显示拼图而非单张
                    preCropIndex = -1;
                    isFromStitch = false;
                    selectedImageIndex = -1;

                    renderStitchImageList();
                    updateStitchPreview();
                    showStitchUI();
                    showToast(currentLang === 'zh' ? '✅ 已更新到列表' : '✅ Updated to list');
                    savePreCropBtn.style.display = 'none';
                    setTimeout(() => {
                        const target = document.querySelector('.stitch-preview-container');
                        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 300);
                };

                if (preCropIndex >= 0) {
                    updateItem(preCropIndex);
                } else {
                    // 普通裁切或拼接后裁切：作为新项追加到列表
                    stitchImages.push({
                        src: dataUrl,
                        width: resultCanvas.width,
                        height: resultCanvas.height
                    });
                    finishSaving();
                }
            });

            function performCrop() {
                if (!uploadedImage) return;
                const actualW = Math.round(cropData.width / canvasScale);
                const actualH = Math.round(cropData.height / canvasScale);
                const actualX = Math.round(cropData.x / canvasScale);
                const actualY = Math.round(cropData.y / canvasScale);
                const borderRadius = parseInt(borderRadiusSlider.value);
                const actualRadius = borderRadius / canvasScale;

                resultCanvas.width = actualW;
                resultCanvas.height = actualH;
                const resCtx = resultCanvas.getContext('2d');
                resCtx.clearRect(0, 0, actualW, actualH);

                if (borderRadius > 0) {
                    resCtx.beginPath();
                    resCtx.moveTo(actualRadius, 0);
                    resCtx.arcTo(actualW, 0, actualW, actualH, actualRadius);
                    resCtx.arcTo(actualW, actualH, 0, actualH, actualRadius);
                    resCtx.arcTo(0, actualH, 0, 0, actualRadius);
                    resCtx.arcTo(0, 0, actualW, 0, actualRadius);
                    resCtx.closePath();
                    resCtx.clip();
                }

                resCtx.save();
                resCtx.translate(-actualX, -actualY);
                const rotatedCanvas = document.createElement('canvas');
                const rad = currentRotation * Math.PI / 180;
                const absCos = Math.abs(Math.cos(rad));
                const absSin = Math.abs(Math.sin(rad));
                const bw = uploadedImage.width * absCos + uploadedImage.height * absSin;
                const bh = uploadedImage.width * absSin + uploadedImage.height * absCos;
                rotatedCanvas.width = bw;
                rotatedCanvas.height = bh;
                const bctx = rotatedCanvas.getContext('2d');
                bctx.translate(bw / 2, bh / 2);
                bctx.rotate(rad);
                bctx.drawImage(uploadedImage, -uploadedImage.width / 2, -uploadedImage.height / 2);
                resCtx.drawImage(rotatedCanvas, 0, 0);
                resCtx.restore();

                cropContainer.style.display = 'none';
                cropResult.style.display = 'block';
                stitchContainer.style.display = 'none';

                // 永远显示“应用到列表”，方便用户将裁切结果反哺给拼接列表
                savePreCropBtn.style.display = 'flex';
                downloadBtn.style.display = 'flex';
                copyBtn.style.display = 'flex';
                newCropBtn.style.display = 'flex';

                if (preCropIndex >= 0 || isFromStitch) {
                    savePreCropBtn.className = 'crop-action-btn crop-btn-success';
                    downloadBtn.className = 'crop-action-btn crop-btn-primary';
                } else {
                    // 普通裁切模式下，应用到列表也是一个很棒的选项
                    savePreCropBtn.className = 'crop-action-btn crop-btn-primary';
                    downloadBtn.className = 'crop-action-btn crop-btn-success';
                }
                setTimeout(() => cropResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
            }

            downloadBtn.addEventListener('click', () => {
                resultCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `cropped_${Date.now()}.png`;
                    link.href = url;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                }, 'image/png');
            });

            copyBtn.addEventListener('click', async () => {
                if (!resultCanvas) {
                    showToast(currentLang === 'zh' ? '❌ 没有可复制的图片' : '❌ No image to copy');
                    return;
                }

                const btnSpan = copyBtn.querySelector('span');
                const originalText = btnSpan.textContent;

                await copyImageToClipboard(
                    resultCanvas,
                    () => {
                        // 成功反馈
                        btnSpan.textContent = translations[currentLang].imageCrop.copiedBtn;
                        copyBtn.classList.remove('crop-btn-primary');
                        copyBtn.classList.add('crop-btn-success');
                        showToast(currentLang === 'zh' ? '✅ 已复制到剪贴板' : '✅ Copied to clipboard');

                        setTimeout(() => {
                            btnSpan.textContent = originalText;
                            copyBtn.classList.remove('crop-btn-success');
                            copyBtn.classList.add('crop-btn-primary');
                        }, 2000);
                    },
                    () => {
                        // 复制失败处理逻辑
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

                        // 如果是 Safari 或移动端，尝试自动下载作为 Fallback
                        if (isMobile || isSafari) {
                            try {
                                const link = document.createElement('a');
                                link.download = `ratio-crop-${new Date().getTime()}.png`;
                                link.href = resultCanvas.toDataURL('image/png');
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                showToast(currentLang === 'zh' ? '⚠️ 浏览器限制无法直接复制，已自动为您下载' : '⚠️ Copied failed, downloading instead');
                            } catch (e) {
                                showToast(currentLang === 'zh' ? '❌ 复制失败，请尝试手动下载' : '❌ Copy failed, please download manually');
                            }
                        } else {
                            showToast(currentLang === 'zh' ? '❌ 复制失败，请尝试下载' : '❌ Copy failed, try download');
                        }
                    }
                );
            });


            newCropBtn.addEventListener('click', () => cancelCropBtn.click());

            const originalUpdateRatio = updateRatio;
            updateRatio = function (width, height) {
                originalUpdateRatio(width, height);
                if (uploadedImage && cropContainer.style.display !== 'none') resetCropArea();
            };

            const devCard = document.getElementById('devCard');
            const toggleDevCardBtn = document.getElementById('toggleDevCard');
            const devAvatar = document.getElementById('devAvatar');
            let isCollapsed = false;
            toggleDevCardBtn.addEventListener('click', () => {
                isCollapsed = !isCollapsed;
                devCard.classList.toggle('collapsed', isCollapsed);
                toggleDevCardBtn.textContent = isCollapsed ? translations[currentLang].developer.expand : translations[currentLang].developer.collapse;
            });
            devAvatar.addEventListener('click', () => {
                if (isCollapsed) {
                    isCollapsed = false;
                    devCard.classList.remove('collapsed');
                    toggleDevCardBtn.textContent = translations[currentLang].developer.collapse;
                }
            });
        </script>
</body>

</html>